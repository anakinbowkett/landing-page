<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ambassador Dashboard - GMM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            background: #f9fafb;
            min-height: 100vh;
        }

        /* Nav */
        .top-nav {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 1.25rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 1.25rem;
        }

        .logo-img { height: 45px; width: auto; }

        .nav-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #9f7261;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .ambassador-name {
            font-size: 0.9375rem;
            font-weight: 600;
            color: #374151;
        }

        .logout-btn {
            background: #f3f4f6;
            color: #374151;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }

        .logout-btn:hover { background: #e5e7eb; }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2.5rem 2rem;
        }

        /* Welcome */
        .welcome-section { margin-bottom: 2.5rem; }

        .welcome-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.375rem;
        }

        .welcome-subtitle {
            font-size: 1rem;
            color: #6b7280;
        }

        /* Phase Labels */
        .phase-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .phase-label::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e5e7eb;
        }

        .phase-1-label { color: #f59e0b; }
        .phase-2-label { color: #1d7fe2; }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: white;
            border-radius: 14px;
            padding: 1.75rem;
            border: 2px solid #e5e7eb;
            transition: all 0.3s;
        }

        .stat-card:hover {
            border-color: #1d7fe2;
            box-shadow: 0 4px 16px rgba(29, 127, 226, 0.1);
        }

        .stat-card.highlight {
            border-color: #1d7fe2;
            background: linear-gradient(135deg, #f0f7ff, #ffffff);
        }

        .stat-label {
            font-size: 0.8125rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.625rem;
        }

        .stat-value {
            font-size: 2.25rem;
            font-weight: 800;
            color: #111827;
            line-height: 1;
        }

        .stat-currency { color: #1d7fe2; }

        .stat-sub {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.5rem;
        }

        .stat-sub span {
            color: #10b981;
            font-weight: 600;
        }

        /* Progress Bar */
        .progress-section {
            background: white;
            border-radius: 14px;
            padding: 1.75rem;
            border: 2px solid #e5e7eb;
            margin-bottom: 2.5rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-title {
            font-size: 1rem;
            font-weight: 700;
            color: #111827;
        }

        .progress-count {
            font-size: 0.9375rem;
            font-weight: 600;
            color: #6b7280;
        }

        .progress-bar-bg {
            width: 100%;
            height: 12px;
            background: #f3f4f6;
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #f59e0b, #f97316);
            border-radius: 9999px;
            transition: width 1s ease;
        }

        .progress-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 0.625rem;
            font-size: 0.75rem;
            color: #9ca3af;
        }

        /* Referral Section */
        .referral-section {
            background: white;
            border-radius: 14px;
            padding: 1.75rem;
            border: 2px solid #e5e7eb;
            margin-bottom: 2.5rem;
        }

        .referral-title {
            font-size: 1rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 1.25rem;
        }

        .referral-link-box {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .referral-link-display {
            flex: 1;
            min-width: 200px;
            background: #f9fafb;
            border: 2px solid #1d7fe2;
            border-radius: 10px;
            padding: 1rem 1.25rem;
            font-size: 1rem;
            font-weight: 600;
            color: #1d7fe2;
            font-family: 'Inter', sans-serif;
        }

        .copy-btn {
            background: #1d7fe2;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 1rem 1.5rem;
            font-size: 0.9375rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .copy-btn:hover {
            background: #1565c0;
            transform: translateY(-2px);
        }

        .referral-hint {
            font-size: 0.8125rem;
            color: #6b7280;
            margin-top: 0.75rem;
        }

        /* Table Section */
        .table-section {
            background: white;
            border-radius: 14px;
            padding: 1.75rem;
            border: 2px solid #e5e7eb;
            margin-bottom: 2.5rem;
        }

        .table-title {
            font-size: 1rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 1.25rem;
        }

        .table-wrapper { overflow-x: auto; }

        table { width: 100%; border-collapse: collapse; }

        thead { background: #f9fafb; }

        th {
            padding: 0.875rem 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid #e5e7eb;
        }

        td {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid #f3f4f6;
            color: #374151;
            font-size: 0.9375rem;
        }

        tbody tr:hover { background: #f9fafb; }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.6875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-verified { background: #d1fae5; color: #065f46; }
        .badge-pending { background: #fef3c7; color: #92400e; }
        .badge-payable { background: #dbeafe; color: #1e40af; }
        .badge-paid { background: #f3f4f6; color: #6b7280; }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #9ca3af;
        }

        .empty-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }

        /* Total Payout Card */
        .total-card {
            background: linear-gradient(135deg, #0a1e3d 0%, #1d7fe2 100%);
            border-radius: 14px;
            padding: 2rem;
            color: white;
            margin-bottom: 2.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .total-label {
            font-size: 0.875rem;
            font-weight: 600;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .total-value {
            font-size: 3rem;
            font-weight: 800;
            line-height: 1;
        }

        .total-note {
            font-size: 0.8125rem;
            opacity: 0.7;
            margin-top: 0.5rem;
        }

        .payout-info {
            text-align: right;
        }

        .payout-date {
            font-size: 1.125rem;
            font-weight: 700;
        }

        .payout-note {
            font-size: 0.8125rem;
            opacity: 0.7;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .top-nav { padding: 1rem; }
            .container { padding: 1.5rem 1rem; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .ambassador-name { display: none; }
            .total-card { flex-direction: column; }
            .payout-info { text-align: left; }
            .referral-link-box { flex-direction: column; }
            .referral-link-display { width: 100%; }
            .copy-btn { width: 100%; }
        }

        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr; }
            .welcome-title { font-size: 1.5rem; }
            .total-value { font-size: 2.25rem; }
        }
    </style>
</head>

    
<body>

<!-- Onboarding Modal -->
<div id="onboardingModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; overflow-y:auto;">
  <div style="max-width:900px; margin:40px auto; background:#fff; border-radius:16px; padding:40px;">
    
    <!-- Stage 1: Terms -->
    <div id="stage1" style="display:none;">
      <h2 style="color:#1d7fe2; margin-bottom:20px;">Terms & Conditions</h2>
      <iframe src="https://pdfhost.io/v/h7fYcY87dn_UGC_Agreement_FEB_2026" style="width:100%; height:500px; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:20px;"></iframe>
      
      <form id="termsForm">
        <div style="margin-bottom:16px;">
          <label style="display:block; font-weight:600; margin-bottom:8px;">Full Name *</label>
          <input type="text" name="fullName" required style="width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:8px; font-size:15px;">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-weight:600; margin-bottom:8px;">Parent/Guardian Name (if under 18) *</label>
          <input type="text" name="parentName" required style="width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:8px; font-size:15px;">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-weight:600; margin-bottom:8px;">Digital Signature *</label>
          <input type="text" name="signature" required placeholder="Type your full name" style="width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:8px; font-size:15px;">
        </div>
        
        <div style="margin-bottom:24px;">
          <label style="display:flex; align-items:center; cursor:pointer;">
            <input type="checkbox" id="termsCheckbox" style="width:20px; height:20px; margin-right:12px;">
            <span>I comply with these terms and conditions on becoming a content creator with Monturalearn</span>
          </label>
        </div>
        
        <button type="submit" id="termsSubmit" disabled style="width:100%; padding:16px; background:#cbd5e1; color:#fff; border:none; border-radius:13px; font-size:16px; font-weight:700; cursor:not-allowed;">Next</button>
      </form>
    </div>

    <!-- Stage 2: Consent -->
    <div id="stage2" style="display:none;">
      <h2 style="color:#1d7fe2; margin-bottom:20px;">Consent Form</h2>
      <iframe src="https://pdfhost.io/v/phxXKuNCug_UGC_Consent_Form_FEB_2026" style="width:100%; height:500px; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:20px;"></iframe>
      
      <form id="consentForm">
        <div style="margin-bottom:16px;">
          <label style="display:block; font-weight:600; margin-bottom:8px;">Parent/Guardian Name *</label>
          <input type="text" name="parentName" required style="width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:8px; font-size:15px;">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-weight:600; margin-bottom:8px;">Relationship to Participant *</label>
          <input type="text" name="relationship" required placeholder="e.g., Mother, Father, Guardian" style="width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:8px; font-size:15px;">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-weight:600; margin-bottom:8px;">Parent Email *</label>
          <input type="email" name="parentEmail" required style="width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:8px; font-size:15px;">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-weight:600; margin-bottom:8px;">Parent Phone *</label>
          <input type="tel" name="parentPhone" required style="width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:8px; font-size:15px;">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-weight:600; margin-bottom:8px;">Participant Name *</label>
          <input type="text" name="participantName" required style="width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:8px; font-size:15px;">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-weight:600; margin-bottom:8px;">Participant Date of Birth *</label>
          <input type="date" name="participantDob" required style="width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:8px; font-size:15px;">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; font-weight:600; margin-bottom:8px;">Digital Signature *</label>
          <input type="text" name="signature" required placeholder="Type your full name" style="width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:8px; font-size:15px;">
        </div>
        
        <div style="margin-bottom:24px;">
          <label style="display:flex; align-items:center; cursor:pointer;">
            <input type="checkbox" id="consentCheckbox" style="width:20px; height:20px; margin-right:12px;">
            <span>I comply with the terms on the consent form and have truthfully filled out the details in order to become a content creator with Monturalearn</span>
          </label>
        </div>
        
        <button type="submit" id="consentSubmit" disabled style="width:100%; padding:16px; background:#cbd5e1; color:#fff; border:none; border-radius:13px; font-size:16px; font-weight:700; cursor:not-allowed;">Next</button>
      </form>
    </div>

    <!-- Stage 3: Guide -->
    <div id="stage3" style="display:none;">
      <h2 style="color:#1d7fe2; margin-bottom:20px;">Content Creator Guide</h2>
      <iframe src="https://pdfhost.io/v/mKFWyHKQND_UGC_GUIDE_FEB_2026" style="width:100%; height:500px; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:20px;"></iframe>
      
      <div style="margin-bottom:24px;">
        <label style="display:flex; align-items:center; cursor:pointer;">
          <input type="checkbox" id="guideCheckbox" style="width:20px; height:20px; margin-right:12px;">
          <span>I comply with the content guide and have familiarised myself with the contents</span>
        </label>
      </div>
      
      <button id="guideSubmit" disabled style="width:100%; padding:16px; background:#cbd5e1; color:#fff; border:none; border-radius:13px; font-size:16px; font-weight:700; cursor:not-allowed;">Complete Onboarding</button>
    </div>

    <!-- Stage 4: Welcome -->
    <div id="stage4" style="display:none; text-align:center;">
      <div style="max-width:600px; margin:0 auto;">
        <p style="font-size:17px; line-height:1.8; color:#1f2937; margin-bottom:30px;">
          I built this for students who are done wasting time on methods that don't work.<br><br>
          Same goes for those who work twice as hard and yet doesn't move the needle.<br><br>
          Or for the ones who don't even know where to start because of all the 'revision' and 'homework'.<br><br>
          The world is cluttered with overpriced, outdated noise.<br><br>
          By joining us, you've committed to a future where high-end quality education isn't a luxuryâ€”it's a standard.<br><br>
          We don't hope for success, it is the only option, and now that you are now an official partner of Monturalearn, you ensure your name is etched into the foundation of that shift in the efficient and affordable way of learning that's accessible for all.<br><br>
          No fluff. No endless hours. Just results.
        </p>
        
        <img src="https://i.postimg.cc/vH9GHtHV/erasebg-transformed.png" alt="Welcome" style="max-width:200px; margin:20px auto; display:block; border-radius:12px;">
        
        <p style="font-size:15px; color:#6b7280; margin-top:20px;">Text below image goes here</p>
        
        <button onclick="closeOnboarding()" style="margin-top:30px; padding:16px 40px; background:#1d7fe2; color:#fff; border:none; border-radius:13px; font-size:16px; font-weight:700; cursor:pointer;">Enter Dashboard</button>
      </div>
    </div>
    
  </div>
</div>

    
    <!-- Nav -->
<nav class="top-nav">
    <div class="nav-left">
        <img src="https://i.postimg.cc/vH9GHtHV/erasebg-transformed.png" alt="GMM Logo" class="logo-img">
        <span class="nav-title">Ambassador Programme</span>
    </div>
    <div class="nav-right">
        <button onclick="window.open('/procurement.html', '_blank')" style="padding:12px 24px; background:#1d7fe2; color:#fff; border:none; border-radius:13px; font-weight:600; cursor:pointer; font-size:15px; margin-right:16px;">Procurement</button>
        <span class="ambassador-name" id="ambassadorName">Loading...</span>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
</nav>

    <!-- Main -->
    <div class="container">

        <!-- Welcome -->
        <div class="welcome-section">
            <h1 class="welcome-title">Welcome back, <span id="welcomeName">Ambassador</span>! ðŸ‘‹</h1>
            <p class="welcome-subtitle">Here's your live performance overview</p>
        </div>

        <!-- Total Payout Card -->
        <div class="total-card">
            <div>
                <div class="total-label">Total Payout Value</div>
                <div class="total-value">Â£<span id="totalPayout">0.00</span></div>
                <div class="total-note">Phase 1 waitlist + Phase 2 subscriptions combined</div>
            </div>
            <div class="payout-info">
                <div class="payout-note">Next payout date</div>
                <div class="payout-date" id="nextPayoutDate">-</div>
                <div class="payout-note">Net-15 rolling commission</div>
            </div>
        </div>

        <!-- Phase 1 -->
        <div class="phase-label phase-1-label">âš¡ Phase 1 â€” Waitlist Growth (ends 28 Feb)</div>

        <div class="stats-grid" style="margin-bottom: 1.25rem;">
            <div class="stat-card">
                <div class="stat-label">Total Signups</div>
                <div class="stat-value" id="totalSignups">0</div>
                <div class="stat-sub">All referral clicks</div>
            </div>
            <div class="stat-card highlight">
                <div class="stat-label">Verified Signups</div>
                <div class="stat-value" id="verifiedSignups">0</div>
                <div class="stat-sub"><span id="remainingCap">100</span> remaining before cap</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Phase 1 Earnings</div>
                <div class="stat-value"><span class="stat-currency">Â£</span><span id="phase1Earnings">0.00</span></div>
                <div class="stat-sub">50p per verified signup</div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-section" style="margin-bottom: 2.5rem;">
            <div class="progress-header">
                <span class="progress-title">Signup Cap Progress</span>
                <span class="progress-count"><span id="capCount">0</span> / 100 signups</span>
            </div>
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="progress-footer">
                <span>0</span>
                <span>Max Â£50 earnings</span>
                <span>100</span>
            </div>
        </div>

        <!-- Phase 2 -->
        <div class="phase-label phase-2-label">ðŸš€ Phase 2 â€” Subscription Commissions (post launch)</div>

        <div class="stats-grid" style="margin-bottom: 2.5rem;">
            <div class="stat-card">
                <div class="stat-label">Active Subscribers</div>
                <div class="stat-value" id="activeSubscriptions">0</div>
                <div class="stat-sub">Currently paying monthly</div>
            </div>
            <div class="stat-card highlight">
                <div class="stat-label">Phase 2 Earnings</div>
                <div class="stat-value"><span class="stat-currency">Â£</span><span id="phase2Earnings">0.00</span></div>
                <div class="stat-sub">Â£2 per active subscriber/month</div>
            </div>
        </div>

        <!-- Referral Link -->
        <div class="referral-section">
            <h2 class="referral-title">Your Referral Link</h2>
            <div class="referral-link-box">
                <input class="referral-link-display" id="referralLinkDisplay" readonly value="Loading...">
                <button class="copy-btn" onclick="copyReferralLink()">Copy Link</button>
            </div>
            <p class="referral-hint">Share this link. Anyone who signs up through it will be tracked automatically.</p>
        </div>

        <!-- Waitlist Signups Table -->
        <div class="table-section">
            <h2 class="table-title">Waitlist Signups (Phase 1)</h2>
            <div class="table-wrapper" id="waitlistTable">
                <div class="loading" style="text-align:center; padding: 2rem; color: #9ca3af;">Loading...</div>
            </div>
        </div>

    </div>

    <script>
let currentReferralCode = null;

// Force show onboarding for testing
window.addEventListener('load', function() {
    setTimeout(function() {
        const modal = document.getElementById('onboardingModal');
        if (modal) {
            console.log('Modal found, checking status...');
            checkOnboardingStatus();
        } else {
            console.log('Modal NOT found in DOM!');
        }
    }, 2000);
});


        
        async function loadDashboard() {
    const ambassador = JSON.parse(localStorage.getItem('ambassador'));

    if (!ambassador) {
        window.location.href = 'ambassador-login.html';
        return;
    }

    currentAmbassadorId = ambassador.id || sessionStorage.getItem('ambassador_id');

    try {
        const response = await fetch(`/api/ambassador-dashboard?email=${ambassador.email}&referralCode=${ambassador.referralCode}`);
        const data = await response.json();

        if (!response.ok || data.error) {
            console.error('Dashboard error:', data.error);
            return;
        }

        // Names
        document.getElementById('ambassadorName').textContent = data.firstName + ' ' + data.lastName;
        document.getElementById('welcomeName').textContent = data.firstName;

        // Referral link
        currentReferralCode = data.referralCode;
        const referralLink = `https://www.monturalearn.co.uk/?ref=${data.referralCode}`;
        document.getElementById('referralLinkDisplay').value = referralLink;

        // Total payout
        document.getElementById('totalPayout').textContent = data.totalPayout.toFixed(2);

        // Next payout date (15th of next month)
        const nextPayout = getNextPayoutDate();
        document.getElementById('nextPayoutDate').textContent = nextPayout;

        // Phase 1
        document.getElementById('totalSignups').textContent = data.phase1.totalSignups;
        document.getElementById('verifiedSignups').textContent = data.phase1.verifiedSignups;
        document.getElementById('phase1Earnings').textContent = data.phase1.earnings.toFixed(2);
        document.getElementById('remainingCap').textContent = data.phase1.remainingCap;
        document.getElementById('capCount').textContent = data.phase1.cappedSignups;

        // Progress bar
        const pct = Math.min((data.phase1.verifiedSignups / 100) * 100, 100);
        document.getElementById('progressBar').style.width = pct + '%';

        // Phase 2
        document.getElementById('activeSubscriptions').textContent = data.phase2.activeSubscriptions;
        document.getElementById('phase2Earnings').textContent = data.phase2.earnings.toFixed(2);

        // Waitlist table
        renderWaitlistTable(data.waitlistCommissions);

    } catch (err) {
        console.error('Network error:', err);
    }
}

        function renderWaitlistTable(commissions) {
            const container = document.getElementById('waitlistTable');

            if (!commissions || commissions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ðŸ“­</div>
                        <p>No waitlist signups yet. Share your referral link to start earning!</p>
                    </div>`;
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Signed Up</th>
                            <th>Status</th>
                            <th>Payable Date</th>
                            <th>Commission</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${commissions.map(c => `
                            <tr>
                                <td>${maskEmail(c.waitlist_email)}</td>
                                <td>${new Date(c.created_at).toLocaleDateString('en-GB')}</td>
                                <td><span class="badge badge-${c.status}">${c.status}</span></td>
                                <td>${c.payable_date ? new Date(c.payable_date).toLocaleDateString('en-GB') : 'â€”'}</td>
                                <td>Â£${parseFloat(c.commission_amount).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
        }

        function maskEmail(email) {
            if (!email) return 'â€”';
            const parts = email.split('@');
            const masked = parts[0].substring(0, 3) + '***';
            return masked + '@' + parts[1];
        }

        function getNextPayoutDate() {
            const today = new Date();
            let payoutMonth = today.getMonth();
            let payoutYear = today.getFullYear();

            if (today.getDate() >= 15) {
                payoutMonth += 1;
                if (payoutMonth > 11) {
                    payoutMonth = 0;
                    payoutYear += 1;
                }
            }

            const payout = new Date(payoutYear, payoutMonth, 15);
            return payout.toLocaleDateString('en-GB', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
        }

        function copyReferralLink() {
            const link = document.getElementById('referralLinkDisplay').value;
            navigator.clipboard.writeText(link).then(() => {
                const btn = event.target;
                btn.textContent = 'Copied! âœ“';
                btn.style.background = '#10b981';
                setTimeout(() => {
                    btn.textContent = 'Copy Link';
                    btn.style.background = '#1d7fe2';
                }, 2000);
            });
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }

        // Load on page load
        document.addEventListener('DOMContentLoaded', loadDashboard);

        // Refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>

<script>
let currentAmbassadorId = null;

// Check if onboarding needed on page load
async function checkOnboardingStatus() {
  const ambassador = JSON.parse(localStorage.getItem('ambassador'));
  if (!ambassador) return;
  
  // Fetch current status
  const response = await fetch(`/api/ambassador-dashboard?email=${ambassador.email}&referralCode=${ambassador.referralCode}`);
  const data = await response.json();
  
  if (data.error) {
    console.error('Failed to load ambassador:', data.error);
    return;
  }
  
  currentAmbassadorId = data.id;
  
  if (!data.onboarding_completed) {
    showOnboarding(data);
  }
}

function showOnboarding(data) {
  document.getElementById('onboardingModal').style.display = 'block';
  
  if (!data.accepted_terms) {
    document.getElementById('stage1').style.display = 'block';
  } else if (!data.accepted_consent) {
    document.getElementById('stage2').style.display = 'block';
  } else if (!data.accepted_guide) {
    document.getElementById('stage3').style.display = 'block';
  } else {
    document.getElementById('stage4').style.display = 'block';
  }
}

function closeOnboarding() {
  document.getElementById('onboardingModal').style.display = 'none';
  location.reload();
}

// Stage 1: Terms
document.getElementById('termsCheckbox').addEventListener('change', function() {
  document.getElementById('termsSubmit').disabled = !this.checked;
  document.getElementById('termsSubmit').style.background = this.checked ? '#1d7fe2' : '#cbd5e1';
  document.getElementById('termsSubmit').style.cursor = this.checked ? 'pointer' : 'not-allowed';
});

document.getElementById('termsForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  
  const response = await fetch('/api/ambassador-dashboard', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      ambassadorId: currentAmbassadorId,
      stage: 'terms',
      formData: {
        fullName: formData.get('fullName'),
        parentName: formData.get('parentName'),
        signature: formData.get('signature'),
        date: new Date().toISOString().split('T')[0]
      }
    })
  });
  
  if (response.ok) {
    document.getElementById('stage1').style.display = 'none';
    document.getElementById('stage2').style.display = 'block';
  }
});

// Stage 2: Consent
document.getElementById('consentCheckbox').addEventListener('change', function() {
  document.getElementById('consentSubmit').disabled = !this.checked;
  document.getElementById('consentSubmit').style.background = this.checked ? '#1d7fe2' : '#cbd5e1';
  document.getElementById('consentSubmit').style.cursor = this.checked ? 'pointer' : 'not-allowed';
});

document.getElementById('consentForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  
  const response = await fetch('/api/ambassador-dashboard', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      ambassadorId: currentAmbassadorId,
      stage: 'consent',
      formData: {
        parentName: formData.get('parentName'),
        relationship: formData.get('relationship'),
        parentEmail: formData.get('parentEmail'),
        parentPhone: formData.get('parentPhone'),
        participantName: formData.get('participantName'),
        participantDob: formData.get('participantDob'),
        signature: formData.get('signature'),
        date: new Date().toISOString().split('T')[0]
      }
    })
  });
  
  if (response.ok) {
    document.getElementById('stage2').style.display = 'none';
    document.getElementById('stage3').style.display = 'block';
  }
});

// Stage 3: Guide
document.getElementById('guideCheckbox').addEventListener('change', function() {
  document.getElementById('guideSubmit').disabled = !this.checked;
  document.getElementById('guideSubmit').style.background = this.checked ? '#1d7fe2' : '#cbd5e1';
  document.getElementById('guideSubmit').style.cursor = this.checked ? 'pointer' : 'not-allowed';
});

document.getElementById('guideSubmit').addEventListener('click', async function() {
  const response = await fetch('/api/ambassador-dashboard', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      ambassadorId: currentAmbassadorId,
      stage: 'guide'
    })
  });
  
  if (response.ok) {
    document.getElementById('stage3').style.display = 'none';
    document.getElementById('stage4').style.display = 'block';
  }
});

// Run on page load - AFTER DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    checkOnboardingStatus();
});

// Also run after loadDashboard completes
window.addEventListener('load', function() {
    setTimeout(checkOnboardingStatus, 1000);
});
</script>
    
</body>
</html>
