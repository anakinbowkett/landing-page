<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lowest Common Multiple - Interactive Lecture</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#ffffff;
  --muted:#6b7280;
  --accent:#1d7fe2;
  --card:#f8fafc;
  --panel-gap:24px;
  --step-bg:#fff;
  --arrow:#cbd5e1;
  --glass: rgba(255,255,255,0.6);
  --border:#e5e7eb;
  --text-primary:#111827;
  --text-secondary:#6b7280;
}

html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  font-family:Inter,system-ui,Segoe UI,Arial;
  color:#111;
  padding-top:110px;
  padding-bottom:60px;
}

.wrap{
  max-width:1400px;
  margin:24px auto;
  padding:28px;
  display:grid;
  grid-template-columns: 1fr 500px;
  gap:var(--panel-gap);
  display:none !important;
}

@media (max-width: 980px){ 
  .wrap{
    grid-template-columns:1fr;
    padding:16px;
    margin:20px auto;
  }
}

.header-bar-1 {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  width: 100%;
  height: 55px;
  background: #ffffff;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 24px;
  z-index: 100;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.lectures-back-btn {
  position: absolute;
  left: 24px;
  font-size: 14px;
  font-weight: 600;
  color: var(--accent);
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 8px;
}

.lectures-back-btn svg {
  width: 20px;
  height: 20px;
}

.lectures-back-btn:hover {
  opacity: 0.8;
}

.reference-btn {
  position: absolute;
  right: 220px;  /* Changed from 200px to add more space */
  font-size: 14px;
  font-weight: 600;
  color: white;
  background: #daa98a;  /* Changed from #1d7fe2 to your new color */
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.reference-btn:hover {
  background: #c4916f;  /* Darker shade for hover effect */
}

.formula-sheet-btn {
  position: absolute;
  right: 80px;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  background: white;
  border: 1px solid var(--border);
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.formula-sheet-btn:hover {
  background: #f9fafb;
  border-color: var(--accent);
  color: var(--accent);
}

.progress-container {
  width: 50%;
  max-width: 600px;
  height: 8px;
  background: #f3f4f6;
  border-radius: 10px;
  overflow: hidden;
  display: flex;
}

.progress-segment {
  height: 100%;
  transition: all 0.3s ease;
}

.header-bar-2 {
  position: fixed;
  top: 55px;
  left: 0;
  right: 0;
  width: 100%;
  height: 55px;
  background: #ffffff;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 24px;
  z-index: 99;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.format-toggle {
  display: flex;
  align-items: center;
  gap: 0;
  background: #f9fafb;
  border-radius: 8px;
  padding: 4px;
  border: 1px solid var(--border);
}

.format-btn {
  padding: 8px 20px;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-secondary);
  background: transparent;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.format-btn.active {
  background: #ffffff;
  color: var(--text-primary);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.format-divider {
  width: 1px;
  height: 24px;
  background: var(--border);
}

.lecture-objective-box {
  background: #fff;
  border-radius: 12px;
  padding: 28px 32px;
  box-shadow: 0 6px 24px rgba(16, 24, 40, 0.06);
  max-width: 1400px;
  width: calc(100% - 56px);
  margin: 0 auto 24px auto;
  border: 1px solid #f0f0f0;
  box-sizing: border-box;
}

.lecture-objective-title {
  font-family: 'Crimson Text', serif;
  font-size: 32px;
  font-weight: 600;
  color: #000000;
  letter-spacing: -0.09em;
  line-height: 1.2;
  margin: 0 0 16px 0;
}

.lecture-objective-content {
  font-family: Inter, system-ui, 'Segoe UI', Arial, sans-serif;
  font-size: 16px;
  color: #464e5a;
  line-height: 1.6;
  margin: 0;
}

.lecture-objective-list {
  list-style: none;
  padding: 0;
  margin: 12px 0 0 0;
}

.lecture-objective-list li {
  padding-left: 24px;
  position: relative;
  margin-bottom: 8px;
  color: #464e5a;
}

.lecture-objective-list li:before {
  content: "•";
  position: absolute;
  left: 8px;
  color: #1d7fe2;
  font-weight: bold;
}

.main-container {
  display: flex;
  height: calc(100vh - 110px);
  width: 100%;
  margin-top: 110px;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
}

.content-side {
  width: 66.666%;
  height: 100%;
  overflow-y: auto;
  overflow-x: hidden;
  background: #ffffff;
}

.chat-side {
  width: 33.333%;
  height: 100%;
  background: #ffffff;
  border-left: 1px solid #e5e7eb;
  display: flex;
  flex-direction: column;
}

.chat-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--border);
  background: white;
  flex-shrink: 0;
}

.chat-title {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0 0 4px 0;
}

.chat-subtitle {
  font-size: 13px;
  color: var(--text-secondary);
  margin: 0;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  background: #f9fafb;
}

.message {
  margin-bottom: 16px;
  display: flex;
  flex-direction: column;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.message-user {
  align-items: flex-end;
}

.message-assistant {
  align-items: flex-start;
}

.message-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 6px;
}

.message-bubble {
  max-width: 85%;
  padding: 12px 16px;
  border-radius: 12px;
  line-height: 1.5;
  font-size: 14px;
}

.message-user .message-bubble {
  background: var(--accent);
  color: white;
  border-bottom-right-radius: 4px;
}

.message-assistant .message-bubble {
  background: white;
  color: var(--text-primary);
  border: 1px solid var(--border);
  border-bottom-left-radius: 4px;
}

.chat-input-area {
  padding: 16px 24px;
  border-top: 1px solid var(--border);
  background: white;
  flex-shrink: 0;
}

.prompts-btn {
  width: 100%;
  padding: 12px;
  background: white;
  border: 1px solid var(--border);
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  cursor: pointer;
  transition: all 0.2s ease;
  margin-bottom: 12px;
}

.prompts-btn:hover {
  background: #f9fafb;
  border-color: var(--accent);
  color: var(--accent);
}

.chat-input-wrapper {
  display: flex;
  gap: 8px;
  align-items: flex-end;
}

.chat-input {
  flex: 1;
  padding: 12px 16px;
  border: 1px solid var(--border);
  border-radius: 10px;
  font-size: 14px;
  font-family: 'Inter', sans-serif;
  resize: none;
  min-height: 56px;
  max-height: 120px;
  outline: none;
  transition: border-color 0.2s;
  line-height: 1.5;
}

.chat-input:focus {
  border-color: var(--accent);
}

.chat-send-btn {
  padding: 12px 20px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
}

.chat-send-btn:hover {
  background: #1d6fd1;
}

.chat-send-btn:disabled {
  background: #cbd5e1;
  cursor: not-allowed;
}

.question-box-1,
.question-box-2,
.question-box-3,
.question-box-4,
.question-box-5,
.question-box-6 {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 32px;
  margin: 20px 32px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  position: relative;
  transition: all 0.3s ease;
  max-width: 1400px;
  width: calc(100% - 64px);
  margin-left: auto;
  margin-right: auto;
  box-sizing: border-box;
  cursor: pointer;
}

.question-box-1.correct,
.question-box-2.correct,
.question-box-3.correct,
.question-box-4.correct,
.question-box-5.correct,
.question-box-6.correct {
  border-color: #54d3ab;
  background: #f0fdf4;
}

.question-box-1.incorrect-selection,
.question-box-2.incorrect-selection,
.question-box-3.incorrect-selection,
.question-box-4.incorrect-selection,
.question-box-5.incorrect-selection,
.question-box-6.incorrect-selection {
  border-color: #e16280;
  background: #fef2f2;
}

.question-number-label-1,
.question-number-label-2,
.question-number-label-3,
.question-number-label-4,
.question-number-label-5,
.question-number-label-6 {
  display: none;
}

.mark-counter-1,
.mark-counter-2,
.mark-counter-3,
.mark-counter-4,
.mark-counter-5,
.mark-counter-6 {
  position: absolute;
  bottom: 32px;
  left: 32px;
  font-size: 14px;
  font-weight: 600;
  color: #6b7280;
  background: #f9fafb;
  padding: 6px 14px;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
  transition: all 0.3s ease;
}

.mark-counter-1.correct,
.mark-counter-2.correct,
.mark-counter-3.correct,
.mark-counter-4.correct,
.mark-counter-5.correct,
.mark-counter-6.correct {
  background: #54d3ab !important;
  color: white !important;
  border-color: #54d3ab !important;
}

.mark-counter-1.incorrect,
.mark-counter-2.incorrect,
.mark-counter-3.incorrect,
.mark-counter-4.incorrect,
.mark-counter-5.incorrect,
.mark-counter-6.incorrect {
  background: #e16280 !important;
  color: white !important;
  border-color: #e16280 !important;
}

.question-title-1,
.question-title-2,
.question-title-3,
.question-title-4,
.question-title-5,
.question-title-6 {
  font-size: 16px !important;
  font-weight: 500;
  color: #111827;
  text-align: center;
  margin: 32px 0 28px 0;
  line-height: 1.6;
}

.answer-container-1,
.answer-container-2,
.answer-container-3,
.answer-container-4,
.answer-container-5,
.answer-container-6 {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin: 0 auto;
  max-width: 600px;
}

.answer-option-1-1,
.answer-option-1-2,
.answer-option-1-3,
.answer-option-1-4,
.answer-option-2-1,
.answer-option-2-2,
.answer-option-2-3,
.answer-option-2-4,
.answer-option-3-1,
.answer-option-3-2,
.answer-option-3-3,
.answer-option-3-4,
.answer-option-4-1,
.answer-option-4-2,
.answer-option-4-3,
.answer-option-4-4,
.answer-option-5-1,
.answer-option-5-2,
.answer-option-5-3,
.answer-option-5-4,
.answer-option-6-1,
.answer-option-6-2,
.answer-option-6-3,
.answer-option-6-4 {
  padding: 16px 20px !important;
  border: 2px solid #e5e7eb !important;
  border-radius: 10px !important;
  font-size: 15px !important;
  font-weight: 450 !important;
  color: #1f2937 !important;
  background: #ffffff !important;
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: left !important;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Inter", sans-serif !important;
  line-height: 1.55 !important;
  letter-spacing: -0.01em !important;
}

.answer-option-1-1:hover:not(:disabled),
.answer-option-1-2:hover:not(:disabled),
.answer-option-1-3:hover:not(:disabled),
.answer-option-1-4:hover:not(:disabled),
.answer-option-2-1:hover:not(:disabled),
.answer-option-2-2:hover:not(:disabled),
.answer-option-2-3:hover:not(:disabled),
.answer-option-2-4:hover:not(:disabled),
.answer-option-3-1:hover:not(:disabled),
.answer-option-3-2:hover:not(:disabled),
.answer-option-3-3:hover:not(:disabled),
.answer-option-3-4:hover:not(:disabled),
.answer-option-4-1:hover:not(:disabled),
.answer-option-4-2:hover:not(:disabled),
.answer-option-4-3:hover:not(:disabled),
.answer-option-4-4:hover:not(:disabled),
.answer-option-5-1:hover:not(:disabled),
.answer-option-5-2:hover:not(:disabled),
.answer-option-5-3:hover:not(:disabled),
.answer-option-5-4:hover:not(:disabled),
.answer-option-6-1:hover:not(:disabled),
.answer-option-6-2:hover:not(:disabled),
.answer-option-6-3:hover:not(:disabled),
.answer-option-6-4:hover:not(:disabled) {
  border-color: #1d7fe2 !important;
  background: #f0f9ff !important;
}

.answer-option-1-1.selected,
.answer-option-1-2.selected,
.answer-option-1-3.selected,
.answer-option-1-4.selected,
.answer-option-2-1.selected,
.answer-option-2-2.selected,
.answer-option-2-3.selected,
.answer-option-2-4.selected,
.answer-option-3-1.selected,
.answer-option-3-2.selected,
.answer-option-3-3.selected,
.answer-option-3-4.selected,
.answer-option-4-1.selected,
.answer-option-4-2.selected,
.answer-option-4-3.selected,
.answer-option-4-4.selected,
.answer-option-5-1.selected,
.answer-option-5-2.selected,
.answer-option-5-3.selected,
.answer-option-5-4.selected,
.answer-option-6-1.selected,
.answer-option-6-2.selected,
.answer-option-6-3.selected,
.answer-option-6-4.selected {
  border-color: #1d7fe2 !important;
  background: #1d7fe2 !important;
  color: white !important;
}

.answer-option-1-1.correct-answer,
.answer-option-1-2.correct-answer,
.answer-option-1-3.correct-answer,
.answer-option-1-4.correct-answer,
.answer-option-2-1.correct-answer,
.answer-option-2-2.correct-answer,
.answer-option-2-3.correct-answer,
.answer-option-2-4.correct-answer,
.answer-option-3-1.correct-answer,
.answer-option-3-2.correct-answer,
.answer-option-3-3.correct-answer,
.answer-option-3-4.correct-answer,
.answer-option-4-1.correct-answer,
.answer-option-4-2.correct-answer,
.answer-option-4-3.correct-answer,
.answer-option-4-4.correct-answer,
.answer-option-5-1.correct-answer,
.answer-option-5-2.correct-answer,
.answer-option-5-3.correct-answer,
.answer-option-5-4.correct-answer,
.answer-option-6-1.correct-answer,
.answer-option-6-2.correct-answer,
.answer-option-6-3.correct-answer,
.answer-option-6-4.correct-answer {
  border-color: #54d3ab !important;
  background: #54d3ab !important;
  color: white !important;
}

.submit-button-1,
.submit-button-2,
.submit-button-3,
.submit-button-4,
.submit-button-5,
.submit-button-6 {
  margin: 24px auto 0 !important;
  padding: 12px 32px !important;
  background: #1d7fe2 !important;
  color: white !important;
  border: none !important;
  border-radius: 8px !important;
  font-size: 15px !important;
  font-weight: 600 !important;
  cursor: pointer;
  transition: all 0.2s ease;
  display: block;
}

.submit-button-1:hover,
.submit-button-2:hover,
.submit-button-3:hover,
.submit-button-4:hover,
.submit-button-5:hover,
.submit-button-6:hover {
  background: #1d6fd1 !important;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(29, 127, 226, 0.3);
}
  
  
/* ============================================
   ENGLISH LITERATURE QUESTION DESIGN
   ============================================ */

.question-header-container {
  display: flex;
  align-items: flex-start;
  gap: 16px;
  margin-bottom: 20px;
  position: relative;
}

.question-number-box {
  flex-shrink: 0;
  width: 50px;
  height: 28px;
  border: 1px solid #000;
  display: flex;
  align-items: stretch;
  justify-content: center;
  gap: 3px;
  background: white;
  font-family: Arial, sans-serif;
  padding: 0;
}

.q-num-small {
  font-size: 16px;
  font-weight: 400;
  color: #000;
  display: flex;
  align-items: center;
}

.q-num-divider {
  font-size: 28px;
  font-weight: 200;
  color: #000;
  margin: 0;
  padding: 0;
  line-height: 1;
  display: flex;
  align-items: stretch;
  align-self: stretch;
}

.q-num-large {
  font-size: 16px;
  font-weight: 400;
  color: #000;
  display: flex;
  align-items: center;
}

.question-instruction {
  flex: 1;
  font-size: 15.5px;
  line-height: 1.4;
  color: #000;
  font-family: Arial, sans-serif;
  padding-top: 4px;
}

.do-not-write-notice {
  display: none;
}

.extract-box {
  border: 1px solid #000;
  padding: 16px;
  margin: 16px 0;
  background: white;
  font-family: Arial, sans-serif;
}

.extract-box p {
  font-size: 15.5px;
  line-height: 1.45;
  color: #000;
  margin: 0;
  text-align: justify;
}

.question-prompt-text {
  font-size: 15.5px;
  font-weight: 400;
  color: #000;
  margin: 18px 0 12px 0;
  font-family: Arial, sans-serif;
  line-height: 1.4;
}

.writing-guidance {
  font-size: 15px;
  color: #000;
  margin: 12px 0;
  font-family: Arial, sans-serif;
}

.writing-guidance ul {
  margin: 6px 0 0 0;
  padding-left: 20px;
}

.writing-guidance li {
  margin-bottom: 2px;
  line-height: 1.4;
}

.marks-indicator {
  text-align: right;
  font-size: 15.5px;
  font-weight: 700;
  color: #000;
  margin: 12px 0 20px 0;
  font-family: Arial, sans-serif;
}

/* Writing Lines */
.writing-lines-container {
  margin: 32px 0;
  position: relative;
  background: white;
  padding: 0 16px;
}

.writing-line {
  min-height: 44px;
  padding: 4px;
  margin-bottom: 4px;
  border-bottom: 1px solid #000;
  font-size: 32px;
  line-height: 1.35;
  color: #000;
  font-family: 'Crimson Text', serif;
  font-weight: 400;
  letter-spacing: -0.02em;
  cursor: text;
  transition: background 0.2s ease;
  position: relative;
  display: block;
  white-space: pre-wrap; /* ← CHANGED: Allows text wrapping */
  word-wrap: break-word; /* ← ADDED: Breaks long words */
  overflow-wrap: break-word; /* ← ADDED: Better wrapping */
  overflow: visible; /* ← CHANGED: From hidden to visible */
  box-sizing: border-box;
}

.writing-line:hover {
  background: #fafafa;
}

.writing-line:focus {
  outline: none;
  background: #fff;
}

.writing-line[contenteditable]:empty:before {
  content: attr(placeholder);
  color: #999;
  font-style: italic;
  pointer-events: none;
}

/* AI Annotations Container */
.ai-annotations-container {
  position: relative;
  margin: 24px 0;
  display: none; /* Hidden until marking happens */
}

/* ============================================
   AI ANNOTATIONS & HIGHLIGHTING (UPDATED)
   ============================================ */

.ai-annotation {
  font-size: 11px;
  line-height: 1.2;
  color: #e16280;
  font-family: 'Crimson Text', serif;
  font-style: italic;
  margin-bottom: 2px;
  padding: 0;
  background: transparent;
  border: none;
  position: relative;
  animation: fadeInAnnotation 0.4s ease forwards;
  opacity: 0;
}

@keyframes fadeInAnnotation {
  to {
    opacity: 1;
  }
}

.ai-annotation.positive {
  color: #0b7e45;
}

.ai-annotation.warning {
  color: #e16280;
}

/* Highlighting - ON TOP of text */
.highlight-green {
  background: rgba(212, 244, 221, 0.85);
  padding: 2px 0;
  border-radius: 2px;
  position: relative;
  z-index: 1;
}

.highlight-yellow {
  background: rgba(254, 243, 199, 0.85);
  padding: 2px 0;
  border-radius: 2px;
  position: relative;
  z-index: 1;
}

.highlight-red {
  background: rgba(254, 226, 226, 0.85);
  padding: 2px 0;
  border-radius: 2px;
  position: relative;
  z-index: 1;
  color: #991b1b;
  font-weight: 500;
}

/* Scanning Effect */
.scanning-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 42px;
  background: linear-gradient(to bottom, 
    transparent 0%, 
    rgba(29, 127, 226, 0.1) 50%, 
    transparent 100%);
  pointer-events: none;
  opacity: 0;
  animation: scanDown 3s ease-in-out forwards;
  z-index: 10;
}

@keyframes scanDown {
  0% {
    top: 0;
    opacity: 0;
  }
  5% {
    opacity: 0.8;
  }
  95% {
    opacity: 0.8;
  }
  100% {
    top: 100%;
    opacity: 0;
  }
}

/* Submit Button Styling */
.submit-button-1,
.submit-button-2,
.submit-button-3,
.submit-button-4,
.submit-button-5,
.submit-button-6 {
  margin: 32px auto 0 !important;
  padding: 14px 48px !important;
  background: #1d7fe2 !important;
  color: white !important;
  border: none !important;
  border-radius: 8px !important;
  font-size: 16px !important;
  font-weight: 600 !important;
  cursor: pointer;
  transition: all 0.3s ease;
  display: block;
  font-family: Arial, sans-serif !important;
}

.submit-button-1:hover,
.submit-button-2:hover,
.submit-button-3:hover,
.submit-button-4:hover,
.submit-button-5:hover,
.submit-button-6:hover {
  background: #1d6fd1 !important;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(29, 127, 226, 0.4);
}

.submit-button-1:disabled,
.submit-button-2:disabled,
.submit-button-3:disabled,
.submit-button-4:disabled,
.submit-button-5:disabled,
.submit-button-6:disabled {
  background: #cbd5e1 !important;
  cursor: not-allowed;
  transform: none;
}
  

  /* Add Page Controls */
.add-page-controls {
  text-align: center;
  margin: 24px 0 32px 0;
}

.add-page-btn {
  padding: 10px 28px;
  background: white;
  color: #1d7fe2;
  border: 2px solid #1d7fe2;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: Arial, sans-serif;
}

.add-page-btn:hover {
  background: #1d7fe2;
  color: white;
}

.add-page-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Additional Pages */
.additional-pages-container {
  margin-top: 40px;
}

.writing-page {
  background: white;
  border: 1px solid #000;
  padding: 32px;
  margin-bottom: 32px;
  position: relative;
  min-height: 600px;
}

.writing-page .writing-lines-container {
  margin: 0;
  padding: 0 16px;
}

.page-number {
  position: absolute;
  bottom: 16px;
  left: 16px;
  font-size: 13px;
  font-weight: 600;
  color: #666;
  font-family: Arial, sans-serif;
}
  
  

/* Marked State */
.question-box-1.marked,
.question-box-2.marked,
.question-box-3.marked,
.question-box-4.marked,
.question-box-5.marked,
.question-box-6.marked {
  border-color: #54d3ab;
}

.question-box-1.marked .ai-annotations-container,
.question-box-2.marked .ai-annotations-container,
.question-box-3.marked .ai-annotations-container,
.question-box-4.marked .ai-annotations-container,
.question-box-5.marked .ai-annotations-container,
.question-box-6.marked .ai-annotations-container {
  display: block;
}  
  
  
  

.question-navigation-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 32px;
  margin: 20px 32px;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  max-width: 1400px;
  width: calc(100% - 64px);
  margin-left: auto;
  margin-right: auto;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.nav-button {
  padding: 10px 24px;
  font-size: 14px;
  font-weight: 600;
  border: 2px solid #1d7fe2;
  border-radius: 8px;
  background: #ffffff;
  color: #1d7fe2;
  cursor: pointer;
  transition: all 0.2s ease;
  min-width: 100px;
  text-align: center;
}

.nav-button:hover:not(:disabled) {
  background: #1d7fe2;
  color: white;
}

.nav-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  border-color: #cbd5e1;
  color: #cbd5e1;
}

.question-counter {
  font-size: 15px;
  font-weight: 600;
  color: #111827;
  padding: 8px 16px;
  background: #f9fafb;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
}

.quiz-progress-container {
  width: 41.6%;
  height: 9px;
  background-color: #f2f2f2;
  border-radius: 10px;
  overflow: hidden;
  margin: 0 auto;
  position: relative;
}

.quiz-progress-segments {
  display: flex;
  width: 100%;
  height: 100%;
}

.quiz-segment {
  height: 100%;
  transition: all 1s ease-out;
  border-right: 2px solid white;
  position: relative;
  background-color: transparent;
}

.quiz-segment:last-child {
  border-right: none;
}

/* ============================================
   MODERN GUIDE DESIGN
   ============================================ */

.guide-hero {
  text-align: center;
  padding: 40px 20px 60px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 16px;
  margin-bottom: 40px;
}

.guide-hero h1 {
  font-size: 42px;
  font-weight: 700;
  color: #000;
  margin: 0 0 12px 0;
  letter-spacing: -0.02em;
}

.guide-subtitle {
  font-size: 18px;
  color: #6b7280;
  margin: 0;
  font-weight: 400;
}

.guide-definition-card {
  background: linear-gradient(135deg, #daa98a 0%, #c4916f 100%);
  padding: 28px 32px;
  border-radius: 12px;
  margin-bottom: 50px;
  box-shadow: 0 4px 12px rgba(218, 169, 138, 0.3);
}

.definition-label {
  font-size: 13px;
  font-weight: 700;
  color: rgba(255,255,255,0.9);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: 8px;
}

.definition-text {
  font-size: 20px;
  color: white;
  line-height: 1.6;
  font-weight: 500;
}

.guide-section {
  margin-bottom: 60px;
}

.section-title {
  font-size: 28px;
  font-weight: 700;
  color: #000;
  margin: 0 0 24px 0;
  padding-bottom: 12px;
  border-bottom: 3px solid #daa98a;
}

.section-content p {
  font-size: 17px;
  line-height: 1.7;
  color: #374151;
  margin-bottom: 16px;
}

.section-content ul {
  list-style: none;
  padding: 0;
  margin: 20px 0;
}

.section-content li {
  font-size: 17px;
  line-height: 1.8;
  color: #374151;
  padding-left: 32px;
  position: relative;
  margin-bottom: 12px;
}

.section-content li:before {
  content: "→";
  position: absolute;
  left: 0;
  color: #daa98a;
  font-weight: 700;
  font-size: 20px;
}

.highlight-term {
  background: rgba(218, 169, 138, 0.2);
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 600;
  color: #8b5a3c;
}

.example-box {
  background: #f0f9ff;
  border-left: 4px solid #1d7fe2;
  padding: 16px 20px;
  margin: 20px 0;
  border-radius: 6px;
  font-size: 16px;
  line-height: 1.7;
  color: #1e40af;
}

/* Three Images Layout */
.guide-images-triple {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 24px;
  margin: 50px 0;
}

.guide-image-card {
  text-align: center;
}

.guide-image-card img {
  width: 100%;
  height: 240px;
  object-fit: cover;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  margin-bottom: 12px;
}

.image-caption {
  font-size: 14px;
  color: #6b7280;
  font-weight: 600;
  margin: 0;
}

/* Feature Rows */
.feature-row {
  display: flex;
  gap: 20px;
  margin-bottom: 28px;
  align-items: flex-start;
}

.feature-number {
  width: 40px;
  height: 40px;
  background: #daa98a;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 700;
  flex-shrink: 0;
}

.feature-content h3 {
  font-size: 19px;
  font-weight: 700;
  color: #000;
  margin: 0 0 8px 0;
}

.feature-content p {
  font-size: 16px;
  color: #4b5563;
  margin: 0 0 10px 0;
}

.feature-example {
  background: #fef3c7;
  padding: 10px 14px;
  border-radius: 6px;
  font-size: 15px;
  color: #92400e;
  border-left: 3px solid #f59e0b;
}

/* Act Timeline */
.act-timeline {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.act-item {
  display: flex;
  gap: 20px;
  align-items: center;
  background: white;
  padding: 20px;
  border-radius: 10px;
  border: 2px solid #e5e7eb;
  transition: all 0.3s ease;
}

.act-item:hover {
  border-color: #daa98a;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.act-badge {
  width: 80px;
  padding: 8px 0;
  background: #daa98a;
  color: white;
  border-radius: 8px;
  text-align: center;
  font-size: 14px;
  font-weight: 700;
  flex-shrink: 0;
}

.act-content h4 {
  font-size: 18px;
  font-weight: 700;
  color: #000;
  margin: 0 0 6px 0;
}

.act-content p {
  font-size: 16px;
  color: #6b7280;
  margin: 0;
}

/* Mistakes Section */
.mistakes-section {
  background: #fef2f2;
  padding: 40px;
  border-radius: 12px;
  border: 2px solid #fecaca;
}

.mistakes-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
}

.mistake-card {
  display: flex;
  gap: 16px;
  background: white;
  padding: 20px;
  border-radius: 10px;
  border: 2px solid #fee2e2;
}

.mistake-icon {
  font-size: 28px;
  color: #e16280;
  flex-shrink: 0;
}

.mistake-text strong {
  display: block;
  font-size: 16px;
  color: #991b1b;
  margin-bottom: 6px;
}

.mistake-text p {
  font-size: 14px;
  color: #6b7280;
  margin: 0;
}

/* Quick Reference Card */
.quick-ref-card {
  background: linear-gradient(135deg, #1d7fe2 0%, #1d6fd1 100%);
  padding: 32px;
  border-radius: 12px;
  margin-top: 50px;
  color: white;
}

.quick-ref-card h3 {
  font-size: 24px;
  font-weight: 700;
  color: white;
  margin: 0 0 20px 0;
}

.checklist {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

.checklist-item {
  font-size: 16px;
  color: white;
  padding: 12px 16px;
  background: rgba(255,255,255,0.15);
  border-radius: 8px;
  font-weight: 500;
}

@media (max-width: 768px) {
  .guide-images-triple {
    grid-template-columns: 1fr;
  }
  
  .mistakes-grid {
    grid-template-columns: 1fr;
  }
  
  .checklist {
    grid-template-columns: 1fr;
  }
}
  
  
  /* ============================================
   TIER 2: FEEDBACK PANEL STYLES
   ============================================ */

.ai-feedback-panel {
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  margin: 24px 0;
  padding: 0;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  animation: slideDown 0.4s ease;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

.feedback-header {
  background: linear-gradient(135deg, #1d7fe2 0%, #1d6fd1 100%);
  padding: 20px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: 10px 10px 0 0;
}

.marks-badge {
  font-size: 28px;
  font-weight: 700;
  color: white;
  font-family: 'Crimson Text', serif;
}

.feedback-status {
  font-size: 14px;
  font-weight: 600;
  padding: 6px 14px;
  border-radius: 20px;
}

.feedback-section {
  padding: 24px;
  border-bottom: 1px solid #f0f0f0;
}

.feedback-section:last-of-type {
  border-bottom: none;
}

.feedback-section h3 {
  font-size: 18px;
  font-weight: 600;
  margin: 0 0 16px 0;
  font-family: 'Crimson Text', serif;
}

.strengths h3 {
  color: #0b7e45;
}

.weaknesses h3 {
  color: #e16280;
}

.next-steps h3 {
  color: #1d7fe2;
}

.feedback-section ul,
.feedback-section ol {
  margin: 0;
  padding-left: 24px;
}

.feedback-section li {
  margin-bottom: 8px;
  line-height: 1.6;
  color: #374151;
}

.weakness-item {
  background: #fef2f2;
  border-left: 4px solid #e16280;
  padding: 16px;
  margin-bottom: 16px;
  border-radius: 6px;
}

.weakness-problem {
  font-size: 15px;
  color: #1f2937;
  margin-bottom: 8px;
}

.weakness-guide {
  font-size: 14px;
  margin: 8px 0;
}

.weakness-guide a {
  color: #1d7fe2;
  text-decoration: none;
  font-weight: 600;
}

.weakness-guide a:hover {
  text-decoration: underline;
}

.weakness-example {
  background: white;
  padding: 12px;
  border-radius: 6px;
  font-size: 14px;
  color: #059669;
  margin-top: 8px;
  font-style: italic;
}

.feedback-actions {
  padding: 20px 24px;
  background: #f9fafb;
  display: flex;
  gap: 12px;
  border-radius: 0 0 10px 10px;
}

.feedback-actions button {
  flex: 1;
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
}

.feedback-actions button:first-child {
  background: #daa98a;
  color: white;
}

.feedback-actions button:first-child:hover {
  background: #c4916f;
}

.feedback-actions button:nth-child(2) {
  background: white;
  color: #1d7fe2;
  border: 2px solid #1d7fe2;
}

.feedback-actions button:nth-child(2):hover {
  background: #1d7fe2;
  color: white;
}

.feedback-actions button:last-child {
  background: #1d7fe2;
  color: white;
}

.feedback-actions button:last-child:hover {
  background: #1d6fd1;
}


</style>
</head>
<body>

<div class="lecture-objective-box">
  <div class="objective-content-wrapper">
    <h1 class="lecture-objective-title">Product of Prime Factors</h1>
    <div class="lecture-objective-content">
      <p style="margin: 0 0 8px 0; font-weight: 600; color: #0b2546;">Lecture Objective:</p>
      <ul class="lecture-objective-list">
        <li>Master the full principles of the Product of Prime Factors</li>
      </ul>
    </div>
  </div>
</div>

<div class="header-bar-1">
  <a href="../lectures.html" class="lectures-back-btn">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
      <polyline points="9 22 9 12 15 12 15 22"></polyline>
    </svg>
    <span>Lectures</span>
  </a>
  
  <div class="quiz-progress-container">
    <div class="quiz-progress-segments" id="progress-segments">
    </div>
  </div>
  
  <button class="reference-btn" id="referenceBtn">
  Reference
</button>

<button class="formula-sheet-btn" id="formulaSheetBtn">
  Formula Sheet
</button>
</div>

<div class="header-bar-2">
  <div class="format-toggle">
    <button class="format-btn active" id="multipleChoiceBtn" onclick="switchFormat('multiple-choice')">
      Multiple Choice
    </button>
    <div class="format-divider"></div>
    <button class="format-btn" id="examFormatBtn" onclick="switchFormat('exam')">
      Exam Format
    </button>
  </div>
</div>

<div class="main-container">
  <div class="content-side" id="contentSide">

<!-- QUESTION 1 - MULTIPLE CHOICE -->
<div class="question-box-1" id="question-box-1">
  <div class="question-number-label-1">Q1 of 6</div>
  <div class="mark-counter-1" id="mark-counter-1">0/1</div>
  <div class="question-title-1">What type of play is Macbeth?</div>
  <div class="answer-container-1">
    <button class="answer-option-1-1" onclick="toggleSingleAnswer1('option1', this)">A Comedy</button>
    <button class="answer-option-1-2" onclick="toggleSingleAnswer1('option2', this)">A Tragedy</button>
    <button class="answer-option-1-3" onclick="toggleSingleAnswer1('option3', this)">A History Play</button>
    <button class="answer-option-1-4" onclick="toggleSingleAnswer1('option4', this)">A Romance</button>
  </div>
  <button class="submit-button-1" id="submit-button-1" onclick="submitAnswer1()">Submit</button>
</div>

<!-- QUESTION 2 - MULTIPLE CHOICE -->
<div class="question-box-2" id="question-box-2">
  <div class="question-number-label-2">Q2 of 6</div>
  <div class="mark-counter-2" id="mark-counter-2">0/1</div>
  <div class="question-title-2">What is Macbeth's fatal flaw that leads to his downfall?</div>
  <div class="answer-container-2">
    <button class="answer-option-2-1" onclick="toggleSingleAnswer2('option1', this)">His loyalty</button>
    <button class="answer-option-2-2" onclick="toggleSingleAnswer2('option2', this)">His ambition</button>
    <button class="answer-option-2-3" onclick="toggleSingleAnswer2('option3', this)">His honesty</button>
    <button class="answer-option-2-4" onclick="toggleSingleAnswer2('option4', this)">His cowardice</button>
  </div>
  <button class="submit-button-2" id="submit-button-2" onclick="submitAnswer2()">Submit</button>
</div>

<!-- QUESTION 3 - MULTIPLE CHOICE -->
<div class="question-box-3" id="question-box-3">
  <div class="question-number-label-3">Q3 of 6</div>
  <div class="mark-counter-3" id="mark-counter-3">0/1</div>
  <div class="question-title-3">Which supernatural element appears in Macbeth?</div>
  <div class="answer-container-3">
    <button class="answer-option-3-1" onclick="toggleSingleAnswer3('option1', this)">Ghosts only</button>
    <button class="answer-option-3-2" onclick="toggleSingleAnswer3('option2', this)">The Witches</button>
    <button class="answer-option-3-3" onclick="toggleSingleAnswer3('option3', this)">Angels</button>
    <button class="answer-option-3-4" onclick="toggleSingleAnswer3('option4', this)">Dragons</button>
  </div>
  <button class="submit-button-3" id="submit-button-3" onclick="submitAnswer3()">Submit</button>
</div>

<!-- QUESTION 4 - WRITTEN RESPONSE (2 MARKS) -->
<div class="question-box-4" id="question-box-4">
  <div class="question-number-label-4">Q4 of 6</div>
  <div class="mark-counter-4" id="mark-counter-4">0/2</div>
  
  <div class="question-header-container">
    <div class="question-number-box">
      <span class="q-num-small">0</span>
      <span class="q-num-divider">|</span>
      <span class="q-num-large">4</span>
    </div>
    <div class="question-instruction">
      Name two key features of a Shakespearean tragedy.
    </div>
  </div>
  
  <div class="writing-guidance">
    Think about:
    <ul>
      <li>What happens to the main character?</li>
      <li>What causes their downfall?</li>
    </ul>
  </div>
  
  <div class="marks-indicator">[2 marks]</div>
  
  <div class="ai-annotations-container" id="ai-annotations-4"></div>
  
  <div class="writing-lines-container" id="writing-lines-4">
    <div class="writing-line" contenteditable="true" data-line="1" placeholder="Feature 1:"></div>
    <div class="writing-line" contenteditable="true" data-line="2" placeholder="Feature 2:"></div>
    <div class="writing-line" contenteditable="true" data-line="3"></div>
  </div>
  
  <button class="submit-button-4" id="submit-button-4" onclick="submitWriting4()">Submit for Marking</button>
</div>

<!-- QUESTION 5 - WRITTEN RESPONSE (3 MARKS) -->
<div class="question-box-5" id="question-box-5">
  <div class="question-number-label-5">Q5 of 6</div>
  <div class="mark-counter-5" id="mark-counter-5">0/3</div>
  
  <div class="question-header-container">
    <div class="question-number-box">
      <span class="q-num-small">0</span>
      <span class="q-num-divider">|</span>
      <span class="q-num-large">5</span>
    </div>
    <div class="question-instruction">
      Explain why Macbeth is considered a tragedy. Give three reasons.
    </div>
  </div>
  
  <div class="writing-guidance">
    You should mention:
    <ul>
      <li>Macbeth's character arc (hero to villain)</li>
      <li>The role of ambition</li>
      <li>The outcome of the play</li>
    </ul>
  </div>
  
  <div class="marks-indicator">[3 marks]</div>
  
  <div class="ai-annotations-container" id="ai-annotations-5"></div>
  
  <div class="writing-lines-container" id="writing-lines-5">
    <div class="writing-line" contenteditable="true" data-line="1" placeholder="Reason 1:"></div>
    <div class="writing-line" contenteditable="true" data-line="2" placeholder="Reason 2:"></div>
    <div class="writing-line" contenteditable="true" data-line="3" placeholder="Reason 3:"></div>
    <div class="writing-line" contenteditable="true" data-line="4"></div>
  </div>
  
  <button class="submit-button-5" id="submit-button-5" onclick="submitWriting5()">Submit for Marking</button>
</div>

<!-- QUESTION 6 - WRITTEN RESPONSE (4 MARKS) -->
<div class="question-box-6" id="question-box-6">
  <div class="question-number-label-6">Q6 of 6</div>
  <div class="mark-counter-6" id="mark-counter-6">0/4</div>
  
  <div class="question-header-container">
    <div class="question-number-box">
      <span class="q-num-small">0</span>
      <span class="q-num-divider">|</span>
      <span class="q-num-large">6</span>
    </div>
    <div class="question-instruction">
      Describe the structure of Macbeth. What happens in each act?
    </div>
  </div>
  
  <div class="writing-guidance">
    Include:
    <ul>
      <li>Act 1: The beginning (witches, ambition starts)</li>
      <li>Act 2: The murder of Duncan</li>
      <li>Act 3: Macbeth becomes paranoid</li>
      <li>Act 4: Witches' prophecies again</li>
      <li>Act 5: Macbeth's death</li>
    </ul>
  </div>
  
  <div class="marks-indicator">[4 marks]</div>
  
  <div class="ai-annotations-container" id="ai-annotations-6"></div>
  
  <div class="writing-lines-container" id="writing-lines-6">
    <div class="writing-line" contenteditable="true" data-line="1" placeholder="Act 1:"></div>
    <div class="writing-line" contenteditable="true" data-line="2" placeholder="Act 2:"></div>
    <div class="writing-line" contenteditable="true" data-line="3" placeholder="Act 3:"></div>
    <div class="writing-line" contenteditable="true" data-line="4" placeholder="Act 4:"></div>
    <div class="writing-line" contenteditable="true" data-line="5" placeholder="Act 5:"></div>
    <div class="writing-line" contenteditable="true" data-line="6"></div>
  </div>
  
  <button class="submit-button-6" id="submit-button-6" onclick="submitWriting6()">Submit for Marking</button>
</div>








<div class="question-navigation-bar">
  <button id="nav-prev-btn" class="nav-button" onclick="previousQuestion()">← Previous</button>
  <div class="question-counter" id="question-counter">Question 1 of 6</div>
  <button id="nav-next-btn" class="nav-button" onclick="nextQuestion()">Next →</button>
</div>

  </div>

  <div class="chat-side">
    <div class="chat-header">
      <div class="chat-title"></div>
      <div class="chat-subtitle" id="chatSubtitle">Click a question to get help</div>
    </div>

    <div class="chat-messages" id="chatMessages"></div>

    <div class="chat-input-area">
      <button class="prompts-btn" id="promptsBtn">Prompts</button>
      
      <div class="chat-input-wrapper">
        <textarea id="chatInput" class="chat-input" placeholder="Ask a question..." rows="2"></textarea>
        <button id="sendBtn" class="chat-send-btn">Execute</button>
      </div>
    </div>
  </div>
</div>

  
  




      
</div>



<!-- Reference Guide Modal -->
<div id="referenceModal" style="
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 1000;
  overflow-y: auto;
  padding: 40px 20px;
">
  <style>
    
    
    
   /* ============================================
   PROFESSIONAL GUIDE DESIGN
   ============================================ */

#referenceModal .container {
  max-width: 900px;  /* Narrower - fits A4 */
  margin: 0 auto;
  background: white;
  border-radius: 12px;
  padding: 50px 60px;
  position: relative;
}

#referenceModal h1 {
  font-size: 32px;
  font-weight: 700;
  margin-bottom: 40px;
  color: #000000;
  letter-spacing: -0.02em;
  line-height: 1.2;
  font-family: 'Crimson Text', serif;
  text-align: center;
  border-bottom: 3px solid #daa98a;
  padding-bottom: 20px;
}

.guide-definition-card {
  background: linear-gradient(135deg, #8b5a3c 0%, #6b4423 100%);
  padding: 24px 28px;
  border-radius: 8px;
  margin-bottom: 40px;
}

.definition-label {
  font-size: 11px;
  font-weight: 700;
  color: rgba(255,255,255,0.8);
  text-transform: uppercase;
  letter-spacing: 0.15em;
  margin-bottom: 10px;
}

.definition-text {
  font-size: 16px;
  color: white;
  line-height: 1.7;
  font-weight: 400;
}

.guide-section {
  margin-bottom: 45px;
}

.section-title {
  font-size: 22px;
  font-weight: 700;
  color: #000;
  margin: 0 0 20px 0;
  padding-bottom: 10px;
  border-bottom: 2px solid #daa98a;
  font-family: 'Crimson Text', serif;
}

.section-content p {
  font-size: 15px;
  line-height: 1.8;
  color: #1f2937;
  margin-bottom: 16px;
  text-align: justify;
}

.example-text {
  font-style: italic;
  color: #4b5563;
  padding-left: 20px;
  border-left: 3px solid #daa98a;
  margin-top: 20px;
}

/* Three Images Layout */
.guide-images-triple {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin: 35px 0;
}

.guide-image-card img {
  width: 100%;
  height: 160px;
  object-fit: cover;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
}

.image-caption {
  font-size: 12px;
  color: #6b7280;
  font-weight: 600;
  margin: 8px 0 0 0;
  text-align: center;
}

/* Feature Items */
.feature-item {
  display: flex;
  gap: 16px;
  margin-bottom: 20px;
  align-items: flex-start;
}

.feature-num {
  width: 24px;
  height: 24px;
  background: #daa98a;
  color: white;
  border-radius: 3px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  font-weight: 700;
  flex-shrink: 0;
}

.feature-text {
  font-size: 15px;
  line-height: 1.8;
  color: #1f2937;
  text-align: justify;
}

.feature-text strong {
  color: #000;
  font-weight: 700;
}

/* Act Structure */
.act-detailed {
  margin-bottom: 24px;
  border-left: 3px solid #daa98a;
  padding-left: 20px;
}

.act-header {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 10px;
}

.act-label {
  background: #8b5a3c;
  color: white;
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 13px;
  font-weight: 700;
  font-family: Arial, sans-serif;
}

.act-name {
  font-size: 17px;
  font-weight: 700;
  color: #000;
}

.act-description {
  font-size: 15px;
  line-height: 1.8;
  color: #374151;
  text-align: justify;
}

@media (max-width: 768px) {
  #referenceModal .container {
    padding: 30px 24px;
  }
  
  .guide-images-triple {
    grid-template-columns: 1fr;
  }
}
  </style>
  
  <button id="closeModalBtn" style="
    position: fixed;
    top: 60px;
    right: 60px;
    background: #daa98a;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 15px;
    z-index: 1001;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    font-family: 'Crimson Text', serif;
  ">Close</button>
























  
<div class="container">
  
  <!-- Title -->
  <h1>Macbeth: Foundation of the Play</h1>
  
  <!-- Definition Card -->
  <div class="guide-definition-card">
    <div class="definition-label">Definition</div>
    <div class="definition-text">
      <strong>Tragedy:</strong> A serious play in which the protagonist (main character) experiences a downfall due to a character flaw or poor decision, ultimately leading to their death. The downfall creates a sense of waste, as the protagonist often possesses admirable qualities but is destroyed by their weakness.
    </div>
  </div>

  <!-- Section 1: What Type of Play -->
  <div class="guide-section">
    <h2 class="section-title">What Type of Play is Macbeth?</h2>
    <div class="section-content">
      <p>Macbeth is a <strong>Shakespearean tragedy</strong>. This classification means the play follows a specific dramatic structure where a noble character is brought down by a critical flaw in their personality. In Macbeth's case, he begins as a respected and valiant Scottish general, admired for his loyalty and courage on the battlefield. However, his unchecked ambition—his fatal flaw—drives him to commit regicide (killing the king), setting off a chain of violent actions that ultimately lead to his own destruction.</p>
      
      <p class="example-text">... Macbeth starts as a brave hero, praised by King Duncan for defeating traitors in battle. His ambition (fatal flaw) is awakened by the witches' prophecies, turning him into a murderous tyrant who kills Duncan, Banquo, and Macduff's family. He dies at the end when Macduff kills him in combat, and Malcolm restores order to Scotland by becoming the rightful king.</p>
    </div>
  </div>

  <!-- Visual Break: Three Images -->
  <div class="guide-images-triple">
    <div class="guide-image-card">
      <img src="https://via.placeholder.com/350x200/8b5a3c/ffffff?text=The+Noble+Hero" alt="Macbeth as hero" />
      <p class="image-caption">Act I: The Noble Hero</p>
    </div>
    <div class="guide-image-card">
      <img src="https://via.placeholder.com/350x200/6b4423/ffffff?text=The+Corruption" alt="Corruption" />
      <p class="image-caption">Acts II-IV: The Corruption</p>
    </div>
    <div class="guide-image-card">
      <img src="https://via.placeholder.com/350x200/4a2f1a/ffffff?text=The+Downfall" alt="Downfall" />
      <p class="image-caption">Act V: The Downfall</p>
    </div>
  </div>

  <!-- Section 2: Key Features -->
  <div class="guide-section">
    <h2 class="section-title">Key Features of Shakespearean Tragedy</h2>
    <div class="section-content">
      
      <div class="feature-item">
        <span class="feature-num">1</span>
        <div class="feature-text">
          <strong>The Tragic Hero:</strong> The protagonist is a person of high status (king, general, nobleman) who commands respect. Macbeth is a Thane (Scottish nobleman) and a celebrated military commander. The hero must be noble enough that their fall from grace creates genuine tragedy—we witness someone with potential for greatness destroyed by their own choices.
        </div>
      </div>

      <div class="feature-item">
        <span class="feature-num">2</span>
        <div class="feature-text">
          <strong>Fatal Flaw (Hamartia):</strong> The hero possesses a critical weakness in their character that leads to their downfall. Macbeth's fatal flaw is his "vaulting ambition" (as he himself describes it). While ambition alone is not inherently evil, Macbeth's ambition is excessive and uncontrolled—he is willing to murder, betray, and terrorize to achieve power. This flaw is exploited by external forces (the witches, Lady Macbeth) but ultimately stems from within his own character.
        </div>
      </div>

      <div class="feature-item">
        <span class="feature-num">3</span>
        <div class="feature-text">
          <strong>Reversal of Fortune (Peripeteia):</strong> The protagonist experiences a dramatic change from prosperity to ruin. Macbeth moves from being honored by the king ("O worthiest cousin!") to becoming a hated tyrant whom his own subjects want dead. His transformation is complete: hero to villain, protector to murderer, loyal subject to usurper.
        </div>
      </div>

      <div class="feature-item">
        <span class="feature-num">4</span>
        <div class="feature-text">
          <strong>Recognition (Anagnorisis):</strong> The hero gains self-awareness and recognizes the truth of their situation, often too late to change it. Macbeth realizes his ambition has led to isolation and meaninglessness. In his "Tomorrow, and tomorrow, and tomorrow" soliloquy, he reflects that life is "a tale told by an idiot, full of sound and fury, signifying nothing"—showing he understands the emptiness of what he has achieved.
        </div>
      </div>

      <div class="feature-item">
        <span class="feature-num">5</span>
        <div class="feature-text">
          <strong>Catharsis:</strong> The audience experiences pity and fear through the hero's suffering, leading to emotional purging. We pity Macbeth because he had potential for good, and we fear because his downfall shows how ambition can corrupt anyone. His death, while deserved, brings a sense of waste—he could have been a great man.
        </div>
      </div>

      <div class="feature-item">
        <span class="feature-num">6</span>
        <div class="feature-text">
          <strong>Supernatural Elements:</strong> The presence of fate, prophecy, or supernatural forces that influence events. The three witches provide prophecies that set Macbeth's ambition in motion. However, Shakespeare leaves it ambiguous whether the witches control fate or merely reveal Macbeth's existing desires. Their prophecies are self-fulfilling: Macbeth's actions to make them come true are what actually cause his downfall.
        </div>
      </div>

      <div class="feature-item">
        <span class="feature-num">7</span>
        <div class="feature-text">
          <strong>Death and Restoration of Order:</strong> The tragic hero must die, and their death restores moral and political order. Macbeth's tyrannical rule creates chaos in Scotland: "Each new day a gash is added to her wounds." His death at Macduff's hands ends the suffering. Malcolm, the rightful heir, becomes king and promises to restore justice, making Scotland "whole" again.
        </div>
      </div>

    </div>
  </div>

  <!-- Section 3: Structure -->
  <div class="guide-section">
    <h2 class="section-title">Structure of Macbeth: The Five-Act Tragic Arc</h2>
    <div class="section-content">
      
      <div class="act-detailed">
        <div class="act-header">
          <span class="act-label">Act I</span>
          <span class="act-name">Exposition and Inciting Incident</span>
        </div>
        <div class="act-description">
          Macbeth, a loyal general, defeats traitors in battle and is praised by King Duncan. On his way home, he encounters three witches who prophesy that he will become Thane of Cawdor and eventually King of Scotland. When the first prophecy immediately comes true (Duncan names him Thane of Cawdor), Macbeth's ambition is awakened. He begins to contemplate murder but is uncertain. Lady Macbeth, upon reading his letter about the prophecies, resolves to push him toward action. She manipulates him by questioning his masculinity and courage, convincing him to murder Duncan when the king visits their castle.
        </div>
      </div>

      <div class="act-detailed">
        <div class="act-header">
          <span class="act-label">Act II</span>
          <span class="act-name">Rising Action and The Murder</span>
        </div>
        <div class="act-description">
          Macbeth murders King Duncan while he sleeps. Immediately, he is consumed with guilt—he hallucinates a bloody dagger and cannot say "Amen" when he hears the guards praying. Lady Macbeth takes control, returning the daggers to frame the guards. When the murder is discovered, Macbeth kills the guards (supposedly in rage) to silence them. Duncan's sons, Malcolm and Donalbain, flee in fear, making them appear guilty. Macbeth is crowned king, but the moral transgression has already begun to corrupt him.
        </div>
      </div>

      <div class="act-detailed">
        <div class="act-header">
          <span class="act-label">Act III</span>
          <span class="act-name">Climax and Further Decline</span>
        </div>
        <div class="act-description">
          Now king, Macbeth is paranoid because the witches prophesied that Banquo's descendants, not his own, will be kings. To secure his position, he hires murderers to kill Banquo and his son Fleance. Banquo is killed, but Fleance escapes. At a banquet, Macbeth sees Banquo's ghost (visible only to him), revealing his guilt and instability to his guests. His erratic behavior causes nobles to suspect him. Macduff notably refuses to attend the banquet and flees to England to join Malcolm. Macbeth's rule is increasingly tyrannical as he seeks to eliminate all threats.
        </div>
      </div>

      <div class="act-detailed">
        <div class="act-header">
          <span class="act-label">Act IV</span>
          <span class="act-name">Falling Action and Deepening Corruption</span>
        </div>
        <div class="act-description">
          Macbeth visits the witches again, demanding more prophecies. They show him three apparitions: beware Macduff; none "of woman born" can harm him; he is safe until Birnam Wood comes to Dunsinane Hill. These prophecies give him false confidence—he believes he is invincible. To punish Macduff for fleeing, Macbeth orders the murder of Macduff's wife and children, a brutal and senseless act that shows his complete moral degradation. Meanwhile, in England, Malcolm tests Macduff's loyalty before agreeing to lead an army against Macbeth.
        </div>
      </div>

      <div class="act-detailed">
        <div class="act-header">
          <span class="act-label">Act V</span>
          <span class="act-name">Catastrophe and Resolution</span>
        </div>
        <div class="act-description">
          Lady Macbeth, consumed by guilt, sleepwalks and tries to wash imaginary bloodstains from her hands ("Out, damned spot!"). She eventually dies (implied suicide). Macbeth receives news of her death with numb indifference—his famous "Tomorrow, and tomorrow, and tomorrow" soliloquy reveals his complete despair and sense of life's meaninglessness. Malcolm's army advances, carrying branches from Birnam Wood as camouflage, fulfilling the prophecy. In battle, Macbeth learns that Macduff was "not of woman born" (born by Caesarean section), nullifying his sense of invincibility. Macduff kills Macbeth in combat, and Malcolm is crowned the rightful King of Scotland, restoring order.
        </div>
      </div>

    </div>
  </div>

</div>

<script>
  function setupCanvas(canvas) {
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    const ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);
    ctx.lineWidth = Math.max(1.5, rect.width * 0.005);
    ctx.strokeStyle = '#daa98a';
    ctx.fillStyle = '#1a1a1a';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    return ctx;
  }

  function circle(ctx, x, y, r) {
    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.stroke();
  }

  function line(ctx, x1, y1, x2, y2) {
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
  }

  function drawStep1() {
    const canvas = document.getElementById('canvas-step1');
    if (!canvas) return;
    const ctx = setupCanvas(canvas);
    const w = canvas.getBoundingClientRect().width;
    const h = canvas.getBoundingClientRect().height;

    ctx.font = `bold ${w * 0.06}px Crimson Text`;
    ctx.fillText('24', w * 0.5, h * 0.15);

    line(ctx, w * 0.5, h * 0.2, w * 0.3, h * 0.4);
    line(ctx, w * 0.5, h * 0.2, w * 0.7, h * 0.4);

    ctx.font = `${w * 0.05}px Crimson Text`;
    ctx.fillText('2', w * 0.3, h * 0.45);
    ctx.fillText('12', w * 0.7, h * 0.45);
  }

  function drawStep2() {
    const canvas = document.getElementById('canvas-step2');
    if (!canvas) return;
    const ctx = setupCanvas(canvas);
    const w = canvas.getBoundingClientRect().width;
    const h = canvas.getBoundingClientRect().height;

    ctx.font = `bold ${w * 0.06}px Crimson Text`;
    ctx.fillText('24', w * 0.5, h * 0.1);

    line(ctx, w * 0.5, h * 0.15, w * 0.3, h * 0.3);
    line(ctx, w * 0.5, h * 0.15, w * 0.7, h * 0.3);

    ctx.fillText('2', w * 0.3, h * 0.35);
    ctx.fillText('12', w * 0.7, h * 0.35);

    line(ctx, w * 0.7, h * 0.38, w * 0.55, h * 0.55);
    line(ctx, w * 0.7, h * 0.38, w * 0.85, h * 0.55);

    ctx.fillText('2', w * 0.55, h * 0.6);
    ctx.fillText('6', w * 0.85, h * 0.6);
  }

  function drawStep3() {
    const canvas = document.getElementById('canvas-step3');
    if (!canvas) return;
    const ctx = setupCanvas(canvas);
    const w = canvas.getBoundingClientRect().width;
    const h = canvas.getBoundingClientRect().height;

    ctx.font = `bold ${w * 0.06}px Crimson Text`;
    ctx.fillText('24', w * 0.5, h * 0.08);

    line(ctx, w * 0.5, h * 0.13, w * 0.3, h * 0.25);
    line(ctx, w * 0.5, h * 0.13, w * 0.7, h * 0.25);

    ctx.fillText('2', w * 0.3, h * 0.3);
    ctx.fillText('12', w * 0.7, h * 0.3);

    line(ctx, w * 0.7, h * 0.33, w * 0.55, h * 0.48);
    line(ctx, w * 0.7, h * 0.33, w * 0.85, h * 0.48);

    ctx.fillText('2', w * 0.55, h * 0.53);
    ctx.fillText('6', w * 0.85, h * 0.53);

    line(ctx, w * 0.85, h * 0.56, w * 0.75, h * 0.7);
    line(ctx, w * 0.85, h * 0.56, w * 0.95, h * 0.7);

    ctx.fillStyle = '#daa98a';
    ctx.fillText('2', w * 0.75, h * 0.75);
    ctx.fillText('3', w * 0.95, h * 0.75);

    circle(ctx, w * 0.3, h * 0.3, w * 0.04);
    circle(ctx, w * 0.55, h * 0.53, w * 0.04);
    circle(ctx, w * 0.75, h * 0.75, w * 0.04);
    circle(ctx, w * 0.95, h * 0.75, w * 0.04);
  }

  window.drawLCMCanvases = function() {
    drawStep1();
    drawStep2();
    drawStep3();
  };
</script>


  </div>
</div>








  
<script>
// Reference button functionality
document.addEventListener('DOMContentLoaded', function() {
  const referenceBtn = document.getElementById('referenceBtn');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const referenceModal = document.getElementById('referenceModal');
  
 if (referenceBtn) {
  referenceBtn.addEventListener('click', function() {
    referenceModal.style.display = 'block';
    document.body.style.overflow = 'hidden';
    
    // Draw canvases after modal opens
    setTimeout(function() {
      if (typeof window.drawLCMCanvases === 'function') {
        window.drawLCMCanvases();
      }
    }, 100);
  });
}
  
  if (closeModalBtn) {
    closeModalBtn.addEventListener('click', function() {
      referenceModal.style.display = 'none';
      document.body.style.overflow = 'auto';
    });
  }
  
  if (referenceModal) {
    referenceModal.addEventListener('click', function(e) {
      if (e.target === this) {
        this.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    });
  }
});
</script>  
  
  
  
  
  
  
  
  
  
<script>
// Question answer functions

  // ============================================
// MULTIPLE CHOICE QUESTIONS (Q1-Q3)
// ============================================

function toggleSingleAnswer1(answer, button) {
  const questionBox = document.getElementById('question-box-1');
  const allButtons = questionBox.querySelectorAll('[class^="answer-option-1"]');
  allButtons.forEach(btn => btn.classList.remove('selected'));
  button.classList.add('selected');
}

function submitAnswer1() {
  const correctAnswer = 'A Tragedy';
  const questionBox = document.getElementById('question-box-1');
  const selectedButtons = questionBox.querySelectorAll('[class^="answer-option-1"].selected');
  const allButtons = questionBox.querySelectorAll('[class^="answer-option-1"]');
  const markCounter = document.getElementById('mark-counter-1');

  const gotItRight = Array.from(selectedButtons).some(btn => btn.textContent.trim() === correctAnswer);
  const yourScore = gotItRight ? 1 : 0;

  markCounter.textContent = `${yourScore}/1`;
  allButtons.forEach(button => {
    if (button.textContent.trim() === correctAnswer) {
      button.classList.add('correct-answer');
    }
    button.disabled = true;
  });

  if (yourScore === 1) {
    markCounter.style.backgroundColor = '#54d3ab';
    markCounter.style.color = 'white';
    questionBox.classList.add('correct');
  } else {
    markCounter.style.backgroundColor = '#e16280';
    markCounter.style.color = 'white';
    questionBox.classList.add('incorrect-selection');
  }

  updateProgressSegment(1);
  const submitBtn = document.getElementById('submit-button-1');
  submitBtn.innerText = 'Reset';
  submitBtn.onclick = resetQuestion1;
}

function resetQuestion1() {
  const questionBox = document.getElementById('question-box-1');
  const buttons = questionBox.querySelectorAll('[class^="answer-option-1"]');
  const submitBtn = document.getElementById('submit-button-1');
  const markCounter = document.getElementById('mark-counter-1');

  buttons.forEach(button => {
    button.classList.remove('selected', 'correct-answer');
    button.disabled = false;
  });

  markCounter.textContent = '0/1';
  markCounter.style.backgroundColor = 'transparent';
  markCounter.style.color = '#555';
  questionBox.classList.remove('correct', 'incorrect-selection');
  resetProgressSegment(1);
  submitBtn.innerText = 'Submit';
  submitBtn.onclick = submitAnswer1;
}

function toggleSingleAnswer2(answer, button) {
  const questionBox = document.getElementById('question-box-2');
  const allButtons = questionBox.querySelectorAll('[class^="answer-option-2"]');
  allButtons.forEach(btn => btn.classList.remove('selected'));
  button.classList.add('selected');
}

function submitAnswer2() {
  const correctAnswer = 'His ambition';
  const questionBox = document.getElementById('question-box-2');
  const selectedButtons = questionBox.querySelectorAll('[class^="answer-option-2"].selected');
  const allButtons = questionBox.querySelectorAll('[class^="answer-option-2"]');
  const markCounter = document.getElementById('mark-counter-2');

  const gotItRight = Array.from(selectedButtons).some(btn => btn.textContent.trim() === correctAnswer);
  const yourScore = gotItRight ? 1 : 0;

  markCounter.textContent = `${yourScore}/1`;
  allButtons.forEach(button => {
    if (button.textContent.trim() === correctAnswer) {
      button.classList.add('correct-answer');
    }
    button.disabled = true;
  });

  if (yourScore === 1) {
    markCounter.style.backgroundColor = '#54d3ab';
    markCounter.style.color = 'white';
    questionBox.classList.add('correct');
  } else {
    markCounter.style.backgroundColor = '#e16280';
    markCounter.style.color = 'white';
    questionBox.classList.add('incorrect-selection');
  }

  updateProgressSegment(2);
  const submitBtn = document.getElementById('submit-button-2');
  submitBtn.innerText = 'Reset';
  submitBtn.onclick = resetQuestion2;
}

function resetQuestion2() {
  const questionBox = document.getElementById('question-box-2');
  const buttons = questionBox.querySelectorAll('[class^="answer-option-2"]');
  const submitBtn = document.getElementById('submit-button-2');
  const markCounter = document.getElementById('mark-counter-2');

  buttons.forEach(button => {
    button.classList.remove('selected', 'correct-answer');
    button.disabled = false;
  });

  markCounter.textContent = '0/1';
  markCounter.style.backgroundColor = 'transparent';
  markCounter.style.color = '#555';
  questionBox.classList.remove('correct', 'incorrect-selection');
  resetProgressSegment(2);
  submitBtn.innerText = 'Submit';
  submitBtn.onclick = submitAnswer2;
}

function toggleSingleAnswer3(answer, button) {
  const questionBox = document.getElementById('question-box-3');
  const allButtons = questionBox.querySelectorAll('[class^="answer-option-3"]');
  allButtons.forEach(btn => btn.classList.remove('selected'));
  button.classList.add('selected');
}

function submitAnswer3() {
  const correctAnswer = 'The Witches';
  const questionBox = document.getElementById('question-box-3');
  const selectedButtons = questionBox.querySelectorAll('[class^="answer-option-3"].selected');
  const allButtons = questionBox.querySelectorAll('[class^="answer-option-3"]');
  const markCounter = document.getElementById('mark-counter-3');

  const gotItRight = Array.from(selectedButtons).some(btn => btn.textContent.trim() === correctAnswer);
  const yourScore = gotItRight ? 1 : 0;

  markCounter.textContent = `${yourScore}/1`;
  allButtons.forEach(button => {
    if (button.textContent.trim() === correctAnswer) {
      button.classList.add('correct-answer');
    }
    button.disabled = true;
  });

  if (yourScore === 1) {
    markCounter.style.backgroundColor = '#54d3ab';
    markCounter.style.color = 'white';
    questionBox.classList.add('correct');
  } else {
    markCounter.style.backgroundColor = '#e16280';
    markCounter.style.color = 'white';
    questionBox.classList.add('incorrect-selection');
  }

  updateProgressSegment(3);
  const submitBtn = document.getElementById('submit-button-3');
  submitBtn.innerText = 'Reset';
  submitBtn.onclick = resetQuestion3;
}

function resetQuestion3() {
  const questionBox = document.getElementById('question-box-3');
  const buttons = questionBox.querySelectorAll('[class^="answer-option-3"]');
  const submitBtn = document.getElementById('submit-button-3');
  const markCounter = document.getElementById('mark-counter-3');

  buttons.forEach(button => {
    button.classList.remove('selected', 'correct-answer');
    button.disabled = false;
  });

  markCounter.textContent = '0/1';
  markCounter.style.backgroundColor = 'transparent';
  markCounter.style.color = '#555';
  questionBox.classList.remove('correct', 'incorrect-selection');
  resetProgressSegment(3);
  submitBtn.innerText = 'Submit';
  submitBtn.onclick = submitAnswer3;
}

// ============================================
// WRITTEN RESPONSE QUESTIONS (Q4-Q6)
// ============================================

// ============================================
// AI-POWERED MARKING (Q4-Q6) - TIER 3 SYSTEM
// ============================================

async function submitWriting4() {
  await submitWritingQuestion(4, 2);
}

async function submitWriting5() {
  await submitWritingQuestion(5, 3);
}

async function submitWriting6() {
  await submitWritingQuestion(6, 4);
}

async function submitWritingQuestion(questionNumber, totalMarks) {
  const container = document.getElementById(`question-box-${questionNumber}`);
  const linesContainer = document.getElementById(`writing-lines-${questionNumber}`);
  const lines = linesContainer.querySelectorAll('.writing-line');
  const submitBtn = document.getElementById(`submit-button-${questionNumber}`);
  const markCounter = document.getElementById(`mark-counter-${questionNumber}`);
  
  let studentText = '';
  let allLineData = [];
  
  lines.forEach((line, index) => {
    const text = line.textContent.trim();
    allLineData.push({ text: text, page: 1, lineIndex: index, element: line });
    if (text) studentText += text + ' ';
  });
  
  if (!studentText.trim()) {
    alert('Please write your answer first!');
    return;
  }
  
  submitBtn.disabled = true;
  submitBtn.textContent = 'AI is marking...';
  
  allLineData.forEach(lineData => {
    lineData.element.contentEditable = false;
  });
  
  const scanOverlay = document.createElement('div');
  scanOverlay.className = 'scanning-overlay';
  linesContainer.appendChild(scanOverlay);
  
  try {
    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        isMarkingRequest: true,
        studentText: studentText.trim(),
        allLineData: allLineData.map(l => ({ text: l.text, page: l.page, lineIndex: l.lineIndex })),
        questionData: {
          exerciseId: `English_Lit_Q${questionNumber}`,
          topic: 'Macbeth - Foundation of Play',
          question: window.QUESTION_BANK[`English_Lit_Q${questionNumber}`].question,
          marks: totalMarks
        }
      })
    });
    
    if (!response.ok) {
      throw new Error(`API returned ${response.status}`);
    }
    
    const result = await response.json();
    
    await new Promise(resolve => setTimeout(resolve, 2000));
    scanOverlay.remove();
    
    // Apply visual highlights (Tier 1)
    if (result.highlights && result.highlights.length > 0) {
      await applyMarkingResults(allLineData, result);
    }
    
    // Show feedback panel (Tier 2)
    showFeedbackPanel(questionNumber, result, totalMarks);
    
    // Update marks
    markCounter.textContent = `${result.marksAwarded}/${totalMarks}`;
    if (result.marksAwarded >= Math.ceil(totalMarks * 0.7)) {
      markCounter.style.backgroundColor = '#54d3ab';
      markCounter.style.color = 'white';
      container.classList.add('correct');
    } else {
      markCounter.style.backgroundColor = '#e16280';
      markCounter.style.color = 'white';
      container.classList.add('incorrect-selection');
    }
    
    container.classList.add('marked');
    updateProgressSegment(questionNumber);
    
    submitBtn.textContent = 'Reset Answer';
    submitBtn.onclick = () => resetWritingQuestion(questionNumber, totalMarks);
    submitBtn.disabled = false;
    
  } catch (error) {
    console.error('Marking error:', error);
    alert('Error during marking: ' + error.message);
    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit for Marking';
    allLineData.forEach(lineData => { lineData.element.contentEditable = true; });
    if (scanOverlay && scanOverlay.parentNode) scanOverlay.remove();
  }
}

function resetWritingQuestion(questionNumber, totalMarks) {
  const container = document.getElementById(`question-box-${questionNumber}`);
  const linesContainer = document.getElementById(`writing-lines-${questionNumber}`);
  const lines = linesContainer.querySelectorAll('.writing-line');
  const submitBtn = document.getElementById(`submit-button-${questionNumber}`);
  const markCounter = document.getElementById(`mark-counter-${questionNumber}`);
  
  lines.forEach(line => {
    line.innerHTML = '';
    line.contentEditable = true;
  });
  
  // Remove feedback panel
  const feedbackPanel = document.getElementById(`feedback-panel-${questionNumber}`);
  if (feedbackPanel) feedbackPanel.remove();
  
  markCounter.textContent = `0/${totalMarks}`;
  markCounter.style.backgroundColor = 'transparent';
  markCounter.style.color = '#555';
  container.classList.remove('correct', 'incorrect-selection', 'marked');
  submitBtn.textContent = 'Submit for Marking';
  submitBtn.onclick = () => {
    if (questionNumber === 4) submitWriting4();
    if (questionNumber === 5) submitWriting5();
    if (questionNumber === 6) submitWriting6();
  };
  resetProgressSegment(questionNumber);
}

// ============================================
// TIER 2: FEEDBACK PANEL
// ============================================

function showFeedbackPanel(questionNumber, result, totalMarks) {
  // Remove existing panel if present
  const existingPanel = document.getElementById(`feedback-panel-${questionNumber}`);
  if (existingPanel) existingPanel.remove();
  
  const container = document.getElementById(`question-box-${questionNumber}`);
  const submitBtn = document.getElementById(`submit-button-${questionNumber}`);
  
  const feedbackPanel = document.createElement('div');
  feedbackPanel.id = `feedback-panel-${questionNumber}`;
  feedbackPanel.className = 'ai-feedback-panel';
  
  // Determine status
  const percentage = (result.marksAwarded / totalMarks) * 100;
  let statusText = 'Needs Improvement';
  let statusColor = '#e16280';
  
  if (percentage >= 90) {
    statusText = 'Excellent';
    statusColor = '#54d3ab';
  } else if (percentage >= 70) {
    statusText = 'Good';
    statusColor = '#54d3ab';
  } else if (percentage >= 50) {
    statusText = 'Satisfactory';
    statusColor = '#f59e0b';
  }
  
  // Build strengths HTML
  let strengthsHTML = '';
  if (result.strengths && result.strengths.length > 0) {
    strengthsHTML = `
      <div class="feedback-section strengths">
        <h3>✓ What You Did Well (${result.marksAwarded}/${totalMarks} marks)</h3>
        <ul>
          ${result.strengths.map(s => `<li>${s}</li>`).join('')}
        </ul>
      </div>
    `;
  }
  
  // Build weaknesses HTML
  let weaknessesHTML = '';
  if (result.weaknesses && result.weaknesses.length > 0) {
    const marksLost = totalMarks - result.marksAwarded;
    weaknessesHTML = `
      <div class="feedback-section weaknesses">
        <h3>✗ How to Improve (Lost ${marksLost} mark${marksLost !== 1 ? 's' : ''})</h3>
        ${result.weaknesses.map(w => `
          <div class="weakness-item">
            <div class="weakness-problem">
              <strong>Missing:</strong> ${w.issue}
            </div>
            <div class="weakness-guide">
              📖 <a href="#" onclick="openGuideSection('${w.guideSection}'); return false;">
                See Guide: ${w.guideSection}
              </a>
            </div>
            ${w.example ? `
              <div class="weakness-example">
                💡 Example: ${w.example}
              </div>
            ` : ''}
          </div>
        `).join('')}
      </div>
    `;
  }
  
  // Build next steps HTML
  let nextStepsHTML = '';
  if (result.nextSteps && result.nextSteps.length > 0) {
    nextStepsHTML = `
      <div class="feedback-section next-steps">
        <h3>📋 Your Next Steps</h3>
        <ol>
          ${result.nextSteps.map(step => `<li>${step}</li>`).join('')}
        </ol>
      </div>
    `;
  }
  
  feedbackPanel.innerHTML = `
    <div class="feedback-header">
      <span class="marks-badge">${result.marksAwarded}/${totalMarks} marks</span>
      <span class="feedback-status" style="background: ${statusColor}20; color: ${statusColor};">
        ${statusText}
      </span>
    </div>
    
    ${strengthsHTML}
    ${weaknessesHTML}
    ${nextStepsHTML}
    
    <div class="feedback-actions">
      <button onclick="openReferenceGuide()">View Full Guide</button>
      <button onclick="resetWritingQuestion(${questionNumber}, ${totalMarks})">Try Again</button>
      <button onclick="askAIAboutQuestion(${questionNumber})">Ask AI for Help</button>
    </div>
  `;
  
  // Insert panel after submit button
  submitBtn.parentNode.insertBefore(feedbackPanel, submitBtn.nextSibling);
}

function openGuideSection(section) {
  // Open reference modal and scroll to section
  const referenceModal = document.getElementById('referenceModal');
  if (referenceModal) {
    referenceModal.style.display = 'block';
    document.body.style.overflow = 'hidden';
  }
  alert(`Opening guide section: ${section}\n(Guide navigation will be fully implemented in next update)`);
}

function openReferenceGuide() {
  const referenceBtn = document.getElementById('referenceBtn');
  if (referenceBtn) {
    referenceBtn.click();
  }
}

function askAIAboutQuestion(questionNumber) {
  // Set current question and focus chat
  if (typeof window.setCurrentQuestion === 'function') {
    window.setCurrentQuestion(questionNumber);
  }
  
  const chatInput = document.getElementById('chatInput');
  if (chatInput) {
    chatInput.value = 'Why did I lose marks on this question?';
    chatInput.focus();
  }
  
  // Scroll to chat
  const chatSide = document.querySelector('.chat-side');
  if (chatSide) {
    chatSide.scrollIntoView({ behavior: 'smooth' });
  }
}


// ============================================
// ENGLISH LITERATURE MARKING SYSTEM
// ============================================

let pageCounters = { 1: 1, 2: 1, 3: 1, 4: 1, 5: 1, 6: 1 };

function resetWriting1() {
  const container = document.getElementById('question-box-1');
  const linesContainer = document.getElementById('writing-lines-1');
  const lines = linesContainer.querySelectorAll('.writing-line');
  const submitBtn = document.getElementById('submit-button-1');
  const markCounter = document.getElementById('mark-counter-1');
  const addPageBtn = document.getElementById('add-page-btn-1');
  
  const annotations = linesContainer.querySelectorAll('.ai-annotation');
  annotations.forEach(ann => ann.remove());
  
  const additionalPages = document.querySelectorAll('#additional-pages-1 .writing-page');
  additionalPages.forEach(page => {
    const pageAnnotations = page.querySelectorAll('.ai-annotation');
    pageAnnotations.forEach(ann => ann.remove());
  });
  
  lines.forEach(line => {
    line.innerHTML = '';
    line.contentEditable = true;
  });
  
  additionalPages.forEach(page => {
    const pageLines = page.querySelectorAll('.writing-line');
    pageLines.forEach(line => {
      line.innerHTML = '';
      line.contentEditable = true;
    });
  });
  
  const additionalPagesContainer = document.getElementById('additional-pages-1');
  if (additionalPagesContainer) {
    additionalPagesContainer.innerHTML = '';
  }
  
  pageCounters[1] = 1;
  markCounter.textContent = '0/8';
  markCounter.classList.remove('correct', 'incorrect');
  container.classList.remove('correct', 'incorrect-selection', 'marked');
  submitBtn.textContent = 'Submit for Marking';
  submitBtn.onclick = submitWriting1;
  if (addPageBtn) addPageBtn.disabled = false;
  resetProgressSegment(1);
}

async function submitWriting1() {
  const container = document.getElementById('question-box-1');
  const linesContainer = document.getElementById('writing-lines-1');
  const lines = linesContainer.querySelectorAll('.writing-line');
  const submitBtn = document.getElementById('submit-button-1');
  const markCounter = document.getElementById('mark-counter-1');
  
  let studentText = '';
  let allLineData = [];
  
  lines.forEach((line, index) => {
    const text = line.textContent.trim();
    allLineData.push({ text: text, page: 1, lineIndex: index, element: line });
    if (text) studentText += text + ' ';
  });
  
  const additionalPages = document.querySelectorAll('#additional-pages-1 .writing-page');
  additionalPages.forEach((page, pageIndex) => {
    const pageLines = page.querySelectorAll('.writing-line');
    pageLines.forEach((line, lineIndex) => {
      const text = line.textContent.trim();
      allLineData.push({ text: text, page: pageIndex + 2, lineIndex: lineIndex, element: line });
      if (text) studentText += text + ' ';
    });
  });
  
  if (!studentText.trim()) {
    alert('Please write your answer first!');
    return;
  }
  
  submitBtn.disabled = true;
  submitBtn.textContent = 'AI is marking...';
  const addPageBtn = document.getElementById('add-page-btn-1');
  if (addPageBtn) addPageBtn.disabled = true;
  
  allLineData.forEach(lineData => {
    lineData.element.contentEditable = false;
  });
  
  const scanOverlay = document.createElement('div');
  scanOverlay.className = 'scanning-overlay';
  linesContainer.appendChild(scanOverlay);
  
  try {
    const response = await fetch('/api/mark-writing', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        exerciseId: 'English_Lit_Q1',
        studentText: studentText.trim(),
        allLineData: allLineData.map(l => ({ text: l.text, page: l.page, lineIndex: l.lineIndex })),
        questionData: {
          topic: 'Language Analysis',
          question: 'How does the writer use language here to describe the hyena\'s appearance?',
          marks: 8
        }
      })
    });
    
    const result = await response.json();
    
    await new Promise(resolve => setTimeout(resolve, 3000));
    scanOverlay.remove();
    
    await applyMarkingResults(allLineData, result);
    
    markCounter.textContent = `${result.marksAwarded}/8`;
    if (result.marksAwarded >= 6) {
      markCounter.classList.add('correct');
      container.classList.add('correct');
    } else {
      markCounter.classList.add('incorrect');
      container.classList.add('incorrect-selection');
    }
    
    container.classList.add('marked');
    updateProgressSegment(1);
    
    submitBtn.textContent = 'Reset Answer';
    submitBtn.onclick = resetWriting1;
    submitBtn.disabled = false;
    
  } catch (error) {
    console.error('Marking error:', error);
    alert('Error during marking. Please try again.');
    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit for Marking';
    if (addPageBtn) addPageBtn.disabled = false;
    allLineData.forEach(lineData => { lineData.element.contentEditable = true; });
    scanOverlay.remove();
  }
}

async function applyMarkingResults(allLineData, result) {
  const markingByPage = {};
  
  allLineData.forEach((lineData) => {
    const pageKey = `page_${lineData.page}`;
    if (!markingByPage[pageKey]) markingByPage[pageKey] = {};
    markingByPage[pageKey][lineData.lineIndex] = {
      element: lineData.element,
      text: lineData.text,
      highlights: []
    };
  });
  
  if (result.highlights) {
    result.highlights.forEach(highlight => {
      const pageKey = `page_${highlight.page}`;
      if (markingByPage[pageKey] && markingByPage[pageKey][highlight.lineIndex]) {
        markingByPage[pageKey][highlight.lineIndex].highlights.push(highlight);
      }
    });
  }
  
  for (const pageKey in markingByPage) {
    for (const lineIndex in markingByPage[pageKey]) {
      const lineMarking = markingByPage[pageKey][lineIndex];
      
      if (lineMarking.highlights.length > 0) {
        applyHighlightsToLine(lineMarking.element, lineMarking.text, lineMarking.highlights);
      }
      
      await new Promise(resolve => setTimeout(resolve, 200));
    }
  }
}

function applyHighlightsToLine(lineElement, originalText, highlights) {
  highlights.sort((a, b) => a.startChar - b.startChar);
  
  let html = '';
  let lastIndex = 0;
  
  highlights.forEach(highlight => {
    html += escapeHtml(originalText.substring(lastIndex, highlight.startChar));
    const highlightedText = originalText.substring(highlight.startChar, highlight.endChar);
    html += `<span class="highlight-${highlight.color}">${escapeHtml(highlightedText)}</span>`;
    lastIndex = highlight.endChar;
  });
  
  html += escapeHtml(originalText.substring(lastIndex));
  lineElement.innerHTML = html;
}

  

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Progress bar
const totalQuestions = 6;

function initializeProgressBar() {
  const container = document.getElementById('progress-segments');
  if (!container) return;
  
  container.innerHTML = '';
  
  for (let i = 1; i <= totalQuestions; i++) {
    const segment = document.createElement('div');
    segment.className = 'quiz-segment';
    segment.style.width = `${100/totalQuestions}%`;
    segment.id = `segment-${i}`;
    
    const icon = document.createElement('div');
    icon.className = 'quiz-segment-icon';
    icon.id = `icon-${i}`;
    
    segment.appendChild(icon);
    container.appendChild(segment);
  }
}

function updateProgressSegment(questionNumber) {
  const questionBox = document.getElementById(`question-box-${questionNumber}`);
  const segment = document.getElementById(`segment-${questionNumber}`);
  const icon = document.getElementById(`icon-${questionNumber}`);
  
  if (!questionBox || !segment || !icon) return;
  
  let color = 'transparent';
  let iconContent = '';
  
  if (questionBox.classList.contains('correct')) {
    color = '#54d3ab';
    iconContent = '✓';
  } else if (questionBox.classList.contains('incorrect-selection')) {
    color = '#e16280';
    iconContent = '✗';
  }
  
  segment.style.backgroundColor = color;
  icon.innerHTML = iconContent;
}

function resetProgressSegment(questionNumber) {
  const segment = document.getElementById(`segment-${questionNumber}`);
  const icon = document.getElementById(`icon-${questionNumber}`);
  
  if (!segment || !icon) return;
  
  segment.style.backgroundColor = 'transparent';
  icon.innerHTML = '';
}

// Question navigation
let currentQuestionIndex = 1;
const totalQuestionsCount = 6;

function initializeQuestionNavigation() {
  for (let i = 1; i <= totalQuestionsCount; i++) {
    const questionBox = document.getElementById(`question-box-${i}`);
    if (questionBox) {
      questionBox.style.display = i === 1 ? 'block' : 'none';
    }
  }
  updateNavigationButtons();
}

function showQuestion(questionNumber) {
  if (questionNumber < 1 || questionNumber > totalQuestionsCount) return;
  
  for (let i = 1; i <= totalQuestionsCount; i++) {
    const questionBox = document.getElementById(`question-box-${i}`);
    if (questionBox) questionBox.style.display = 'none';
  }
  
  const selectedBox = document.getElementById(`question-box-${questionNumber}`);
  if (selectedBox) {
    selectedBox.style.display = 'block';
    setTimeout(() => { selectedBox.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 50);
  }
  
  currentQuestionIndex = questionNumber;
  updateNavigationButtons();
}

function nextQuestion() {
  if (currentQuestionIndex < totalQuestionsCount) {
    showQuestion(currentQuestionIndex + 1);
  }
}

function previousQuestion() {
  if (currentQuestionIndex > 1) {
    showQuestion(currentQuestionIndex - 1);
  }
}

function updateNavigationButtons() {
  const prevBtn = document.getElementById('nav-prev-btn');
  const nextBtn = document.getElementById('nav-next-btn');
  const counter = document.getElementById('question-counter');
  
  if (prevBtn) {
    prevBtn.disabled = currentQuestionIndex === 1;
    prevBtn.style.opacity = currentQuestionIndex === 1 ? '0.5' : '1';
  }
  
  if (nextBtn) {
    nextBtn.disabled = currentQuestionIndex === totalQuestionsCount;
    nextBtn.style.opacity = currentQuestionIndex === totalQuestionsCount ? '0.5' : '1';
  }
  
  if (counter) {
    counter.textContent = `Question ${currentQuestionIndex} of ${totalQuestionsCount}`;
  }
}

// Mock backend - Smart Marking
const originalFetch = window.fetch;
window.fetch = async function(url, options) {
  if (url === '/api/mark-writing') {
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    const body = JSON.parse(options.body);
    const studentText = body.studentText.toLowerCase();
    
    // Realistic marking criteria
    const hasQuotes = (studentText.match(/["']/g) || []).length >= 2;
    const hasTechniques = /metaphor|simile|personification|imagery|adjective|verb|alliteration/i.test(studentText);
    const hasExplanation = studentText.length > 80;
    const hasLinkToQuestion = /writer|describe|appearance|language|hyena/i.test(studentText);
    
    let marks = 0;
    if (hasQuotes) marks += 2;
    if (hasTechniques) marks += 2;
    if (hasExplanation) marks += 2;
    if (hasLinkToQuestion) marks += 2;
    
    const mockHighlights = [];
    const mockAnnotations = [];
    
    // Process each line
    body.allLineData.forEach((lineData, index) => {
      const lineText = lineData.text;
      if (!lineText || lineText.length === 0) return;
      
      // Find quotes and highlight green
      const quoteMatches = [...lineText.matchAll(/["']([^"']+)["']/g)];
      quoteMatches.forEach(match => {
        mockHighlights.push({
          page: lineData.page,
          lineIndex: lineData.lineIndex,
          startChar: match.index,
          endChar: match.index + match[0].length,
          color: 'green'
        });
      });
      
      if (quoteMatches.length > 0 && mockAnnotations.filter(a => a.type === 'positive').length === 0) {
        mockAnnotations.push({
          page: lineData.page,
          lineIndex: lineData.lineIndex,
          text: '✓ Good quotations',
          type: 'positive'
        });
      }
      
      // Find technique words and highlight yellow
      const techniques = ['metaphor', 'simile', 'personification', 'imagery', 'adjective', 'alliteration'];
      techniques.forEach(tech => {
        const idx = lineText.toLowerCase().indexOf(tech);
        if (idx !== -1) {
          mockHighlights.push({
            page: lineData.page,
            lineIndex: lineData.lineIndex,
            startChar: idx,
            endChar: idx + tech.length,
            color: 'yellow'
          });
        }
      });
      
      // Add feedback for short answers
      if (index === 0 && lineText.length < 20 && lineText.length > 0) {
        mockAnnotations.push({
          page: lineData.page,
          lineIndex: lineData.lineIndex,
          text: 'Needs more detail - explain the effect',
          type: 'warning'
        });
      }
      
      // Flag vague language
      if (/good|bad|nice|shows|makes/i.test(lineText) && !/because|suggests|implies/i.test(lineText)) {
        const vaguePhraseMatch = lineText.match(/\b(good|bad|nice|shows|makes)\b/i);
        if (vaguePhraseMatch && mockAnnotations.filter(a => a.type === 'warning').length < 2) {
          mockAnnotations.push({
            page: lineData.page,
            lineIndex: lineData.lineIndex,
            text: 'Be more specific - how does it show this?',
            type: 'warning'
          });
        }
      }
    });
    
    // If almost no content, give 0-1 marks
    if (studentText.length < 20) {
      marks = Math.min(marks, 1);
      if (mockAnnotations.length === 0) {
        mockAnnotations.push({
          page: 1,
          lineIndex: 0,
          text: 'Your answer is too short. Add quotations and explain the language.',
          type: 'warning'
        });
      }
    }
    
    return {
      ok: true,
      json: async () => ({
        marksAwarded: marks,
        highlights: mockHighlights,
        annotations: mockAnnotations
      })
    };
  }
  
  return originalFetch(url, options);
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  initializeProgressBar();
  initializeQuestionNavigation();
});
  
// ============================================
// AI CHAT SYSTEM (Transferred from Maths)
// ============================================

document.addEventListener('DOMContentLoaded', function() {
  console.log('Initializing DeepSeek chat interface...');
  
  const chatMessages = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendBtn');
  const promptsBtn = document.getElementById('promptsBtn');
  const chatSubtitle = document.getElementById('chatSubtitle');
  
  window.conversationHistory = [];
  window.currentQuestionId = null;
  
  // ENGLISH LITERATURE QUESTION BANK
 window.QUESTION_BANK = {
  'English_Lit_Q1': {
    question: 'What type of play is Macbeth?',
    correctAnswer: 'A Tragedy',
    topic: 'Macbeth - Foundation of Play',
    marks: 1
  },
  'English_Lit_Q2': {
    question: 'What is Macbeth\'s fatal flaw that leads to his downfall?',
    correctAnswer: 'His ambition',
    topic: 'Macbeth - Foundation of Play',
    marks: 1
  },
  'English_Lit_Q3': {
    question: 'Which supernatural element appears in Macbeth?',
    correctAnswer: 'The Witches',
    topic: 'Macbeth - Foundation of Play',
    marks: 1
  },
  'English_Lit_Q4': {
    question: 'Name two key features of a Shakespearean tragedy.',
    correctAnswer: 'Fatal flaw, downfall, death',
    topic: 'Macbeth - Foundation of Play',
    marks: 2
  },
  'English_Lit_Q5': {
    question: 'Explain why Macbeth is considered a tragedy. Give three reasons.',
    correctAnswer: 'Hero to villain, ambition, death',
    topic: 'Macbeth - Foundation of Play',
    marks: 3
  },
  'English_Lit_Q6': {
    question: 'Describe the structure of Macbeth. What happens in each act?',
    correctAnswer: 'Act structure with key events',
    topic: 'Macbeth - Foundation of Play',
    marks: 4
  }
};
  
  function addMessageToChat(content, isUser) {
    if (!chatMessages) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = isUser ? 'message message-user' : 'message message-assistant';
    
    const label = document.createElement('div');
    label.className = 'message-label';
    label.textContent = isUser ? 'You' : '';
    label.style.display = isUser ? 'block' : 'none';
    
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.textContent = content;
    
    messageDiv.appendChild(label);
    messageDiv.appendChild(bubble);
    chatMessages.appendChild(messageDiv);
    
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
  
  async function sendToDeepSeek(message) {
    if (!window.currentQuestionId) {
      return 'Please click on a question box first to select a question!';
    }
    
    const questionData = window.QUESTION_BANK[window.currentQuestionId];
    
    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: message,
          conversationHistory: window.conversationHistory,
          questionData: questionData
        })
      });
      
      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }
      
      const data = await response.json();
      
      window.conversationHistory.push(
        { role: 'user', content: message },
        { role: 'assistant', content: data.reply }
      );
      
      return data.reply;
      
    } catch (error) {
      console.error('DeepSeek API Error:', error);
      return 'Sorry, I had trouble connecting to the AI. Please try again.';
    }
  }
  
  async function handleSendMessage() {
    const message = chatInput.value.trim();
    if (!message || !sendBtn) return;
    
    addMessageToChat(message, true);
    chatInput.value = '';
    
    sendBtn.disabled = true;
    sendBtn.textContent = 'Thinking...';
    
    const response = await sendToDeepSeek(message);
    addMessageToChat(response, false);
    
    sendBtn.disabled = false;
    sendBtn.textContent = 'Execute';
  }
  
  if (sendBtn) {
    sendBtn.addEventListener('click', handleSendMessage);
  }
  
  if (chatInput) {
    chatInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSendMessage();
      }
    });
  }
  
  if (promptsBtn) {
    promptsBtn.addEventListener('click', function() {
      const prompts = [
        "How do I analyze language?",
        "What techniques should I look for?",
        "How do I explain effects?",
        "What makes a good quotation?",
        "How do I structure my answer?"
      ];
      const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];
      if (chatInput) {
        chatInput.value = randomPrompt;
        chatInput.focus();
      }
    });
  }
  
  window.setCurrentQuestion = function(questionNumber) {
  console.log('Setting current question to:', questionNumber);
  window.currentQuestionId = `English_Lit_Q${questionNumber}`; // ← REMOVED _Hyena
  window.conversationHistory = [];
  
  const questionData = window.QUESTION_BANK[window.currentQuestionId];
  const chatSubtitle = document.getElementById('chatSubtitle');
  
  if (questionData && chatSubtitle) {
    chatSubtitle.textContent = `Q${questionNumber}: ${questionData.topic}`;
  }
  
  document.querySelectorAll('[class^="question-box-"]').forEach(box => {
    box.style.borderColor = '#e5e7eb';
  });
  
  const activeBox = document.getElementById(`question-box-${questionNumber}`);
  if (activeBox) {
    activeBox.style.borderColor = '#1d7fe2';
  }
};
  
  setTimeout(() => {
    window.setCurrentQuestion(1);
  }, 1000);
  
  // Make question boxes clickable for chat
  for (let i = 1; i <= totalQuestionsCount; i++) {
    const questionBox = document.getElementById(`question-box-${i}`);
    if (questionBox) {
      questionBox.addEventListener('click', function(e) {
        e.stopPropagation();
        showQuestion(i);
        if (typeof window.setCurrentQuestion === 'function') {
          window.setCurrentQuestion(i);
        }
      });
    }
  }
  
const formulaBtn = document.getElementById('formulaSheetBtn');
  if (formulaBtn) {
    formulaBtn.addEventListener('click', function() {
      alert('Formula Sheet feature');
    });
  }
});

// ============================================
// FIX 3: PREVENT LINE MOVEMENT ON ENTER/BACKSPACE
// ============================================

document.addEventListener('DOMContentLoaded', function() {
  const writingLines = document.querySelectorAll('.writing-line');
  
  writingLines.forEach((line, index, allLines) => {
    line.addEventListener('keydown', function(e) {
      
      // Handle ENTER key
      if (e.key === 'Enter') {
        e.preventDefault();
        
        // Move cursor to next line
        const nextLine = allLines[index + 1];
        if (nextLine) {
          nextLine.focus();
          
          // Place cursor at start of next line
          const range = document.createRange();
          const sel = window.getSelection();
          
          if (nextLine.childNodes.length > 0) {
            range.setStart(nextLine.childNodes[0], 0);
          } else {
            range.setStart(nextLine, 0);
          }
          
          range.collapse(true);
          sel.removeAllRanges();
          sel.addRange(range);
        }
      }
      
      // Handle BACKSPACE at start of line
      if (e.key === 'Backspace') {
        const sel = window.getSelection();
        const cursorPosition = sel.anchorOffset;
        
        // If cursor is at the very start of the line
        if (cursorPosition === 0 && sel.anchorNode === line) {
          e.preventDefault();
          
          // Move to end of previous line
          const prevLine = allLines[index - 1];
          if (prevLine) {
            prevLine.focus();
            
            // Place cursor at end of previous line
            const range = document.createRange();
            const sel = window.getSelection();
            
            if (prevLine.childNodes.length > 0) {
              const lastNode = prevLine.childNodes[prevLine.childNodes.length - 1];
              const offset = lastNode.textContent ? lastNode.textContent.length : 0;
              range.setStart(lastNode, offset);
            } else {
              range.setStart(prevLine, 0);
            }
            
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
          }
        }
      }
    });
  });
});

</script>
</body>
</html>
